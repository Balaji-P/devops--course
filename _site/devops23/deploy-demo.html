<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hands-On Time | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hands-On Time" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/devops23/deploy-demo.html" />
<meta property="og:url" content="http://localhost:4000/devops23/deploy-demo.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/devops23/deploy-demo.html","@type":"WebPage","headline":"Hands-On Time","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h2 id="hands-on-time">Hands-On Time</h2>

<hr />

<h1 id="deploying-releases-with-zero-downtime">Deploying Releases With Zero-Downtime</h1>

<h2 id="deploying-new-releases">Deploying New Releases</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>deploy/go-demo-2-db.yml

kubectl create <span class="nt">-f</span> deploy/go-demo-2-db.yml <span class="nt">--record</span>

kubectl get <span class="nt">-f</span> deploy/go-demo-2-db.yml

kubectl describe <span class="nt">-f</span> deploy/go-demo-2-db.yml

kubectl get all
</code></pre></div></div>

<p>Note:
If you compare this Deployment with the ReplicaSet we created in the previous chapter, you’ll probably have a hard time finding a difference. Apart from the kind field, they are the same. Since, in this case, both the Deployment and the ReplicaSet are the same, you might be wondering what the advantage of using one over the other is. We will regularly add –record to the kubectl create commands. This allows us to track each change to our resources such as a Deployments.
<code class="highlighter-rouge">kubectl describe -f deploy/go-demo-2-db.yml</code>
From the Events section, we can observe that the Deployment created a ReplicaSet. Or, to be more precise, that it scaled it. That is interesting. It shows that Deployments control ReplicaSets. The Deployment created the ReplicaSet which, in turn, created Pods. Let’s confirm that by retrieving the list of all the objects.
<code class="highlighter-rouge">kubectl get all</code>
You’ll notice that contained within the name of the Pod is a hash which matches the hash in the name of the new ReplicaSet, namely f8d4b86ff. Even though it might look like it is a random value, it is not. If you destroy the Deployment and create it again, you’ll notice that the hash in the Pod name and ReplicaSet name remain consistent. This value is generated by hashing the PodTemplate of the ReplicaSet. As long as the PodTemplate is the same, the hash value will be the same as well. That way a Deployment can know whether anything related to the Pods has changed and, if it does, will create a new ReplicaSet. The kubectl set image command is not the only way to update a Deployment. We could also have used kubectl edit as well. The command would be as follows. Please do NOT execute it. If you do (against my advice), you’ll need to type :q followed by the enter key to exit.</p>

<!-- .slide: data-background="img/deployment.png" data-background-size="contain" -->

<!-- .slide: data-background="img/seq_deploy_ch06.png" data-background-size="contain" -->

<h2 id="updating-deployments">Updating Deployments</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">set </span>image <span class="nt">-f</span> deploy/go-demo-2-db.yml <span class="nv">db</span><span class="o">=</span>mongo:3.4 <span class="nt">--record</span>

kubectl describe <span class="nt">-f</span> deploy/go-demo-2-db.yml

kubectl get all

kubectl edit <span class="nt">-f</span> deploy/go-demo-2-db.yml

<span class="c"># Exit with `:q` if vi</span>

kubectl create <span class="nt">-f</span> deploy/go-demo-2-db-svc.yml <span class="nt">--record</span>
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We changed the image of the <code class="highlighter-rouge">db</code> container definition in the Deployment</li>
  <li>We described the deployment to confirm that the image changed</li>
  <li>We retrieved all the resources and observed that a new ReplicaSet was created which, in turn, created a new Pod</li>
  <li>We tried to edit the resources definition but gave up since it is a bad practice</li>
  <li>We created a Service for the DB</li>
</ul>

<h2 id="zero-downtime-deployments">Zero-Downtime Deployments</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>deploy/go-demo-2-api.yml

kubectl create <span class="nt">-f</span> deploy/go-demo-2-api.yml <span class="nt">--record</span>

kubectl get <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl <span class="nb">set </span>image <span class="nt">-f</span> deploy/go-demo-2-api.yml <span class="se">\</span>
    <span class="nv">api</span><span class="o">=</span>vfarcic/go-demo-2:2.0 <span class="nt">--record</span>

kubectl rollout status <span class="nt">-w</span> <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl describe <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl rollout <span class="nb">history</span> <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl get rs
</code></pre></div></div>

<p>Note:
Regarding <code class="highlighter-rouge">cat go-demo-2-api</code></p>
<ul>
  <li><code class="highlighter-rouge">minReadySeconds</code> defines the minimum number of seconds before Kubernetes starts considering the Pods healthy. We put the value of this field to 1 second. The default value is 0, meaning that the Pods will be considered available as soon as they are ready and, when specified, livenessProbe returns OK. If in doubt, omit this field and leave it to the default value of 0. We defined it mostly for demonstration purposes.</li>
  <li><code class="highlighter-rouge">revisionHistoryLimit</code>. It defines the number of old ReplicaSets we can rollback. Like most of the fields, it is set to the sensible default value of 10. We changed it to 5 and, as a result, we will be able to rollback to any of the previous five ReplicaSets.</li>
  <li>The <code class="highlighter-rouge">strategy</code> can be either the <code class="highlighter-rouge">RollingUpdate</code> or the <code class="highlighter-rouge">Recreate</code> type. <code class="highlighter-rouge">RollingUpdate</code> is the default strategy, and the only that will allow for Zero-Downtime deployments</li>
  <li>When <code class="highlighter-rouge">RollingUpdate</code> is the strategy of choice, it can be fine-tuned with the <code class="highlighter-rouge">maxSurge</code> and <code class="highlighter-rouge">maxUnavailable</code> fields. The former defines the maximum number of Pods that can exceed the desired number (set using replicas). It can be set to an absolute number (e.g., 2) or a percentage (e.g., 35%). The total number of Pods will never exceed the desired number (set using replicas) and the maxSurge combined. The default value is 25%.</li>
  <li><code class="highlighter-rouge">maxUnavailable</code> defines the maximum number of Pods that are not operational. If, for example, the number of replicas is set to 15 and this field is set to 4, the minimum number of Pods that would run at any given moment would be 11</li>
  <li>We changed the image of the <code class="highlighter-rouge">api</code> container definition in the API Deployment</li>
  <li>We executed <code class="highlighter-rouge">rollout status</code> to watch the progress of the update</li>
  <li>We executed <code class="highlighter-rouge">rollout history</code> and observed that we made two revisions</li>
  <li>We retrieved all the ReplicaSets and observed that new ones we created with each update</li>
</ul>

<!-- .slide: data-background="img/flow_deploy_ch06.png" data-background-size="contain" -->

<h2 id="rolling-back-or-forward">Rolling Back Or Forward?</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout undo <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl describe <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl rollout <span class="nb">history</span> <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl <span class="nb">set </span>image <span class="nt">-f</span> deploy/go-demo-2-api.yml <span class="se">\</span>
    <span class="nv">api</span><span class="o">=</span>vfarcic/go-demo-2:3.0 <span class="nt">--record</span>

kubectl rollout status <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl <span class="nb">set </span>image <span class="nt">-f</span> deploy/go-demo-2-api.yml <span class="se">\</span>
    <span class="nv">api</span><span class="o">=</span>vfarcic/go-demo-2:4.0 <span class="nt">--record</span>

kubectl rollout status <span class="nt">-f</span> deploy/go-demo-2-api.yml
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We undid the last update</li>
  <li>We described the deployment to observe the events related to ReplicaSets</li>
  <li>We output <code class="highlighter-rouge">rollout history</code> and observed that a new revision was created</li>
  <li>We updated the image of the <code class="highlighter-rouge">api</code> twice to generate a few more revisions</li>
</ul>

<h2 id="rolling-back-or-forward-1">Rolling Back Or Forward?</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout <span class="nb">history</span> <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl <span class="nb">set </span>image <span class="nt">-f</span> deploy/go-demo-2-api.yml <span class="se">\</span>
    <span class="nv">api</span><span class="o">=</span>vfarcic/go-demo-2:2.0 <span class="nt">--record</span>

kubectl rollout undo <span class="nt">-f</span> deploy/go-demo-2-api.yml <span class="nt">--to-revision</span><span class="o">=</span>4

kubectl rollout <span class="nb">history</span> <span class="nt">-f</span> deploy/go-demo-2-api.yml
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We output <code class="highlighter-rouge">rollout history</code> to confirm that all the revisions were recorded</li>
  <li>We are going to execute one more update</li>
  <li>We are going roll out to the revision <code class="highlighter-rouge">4</code></li>
  <li>We going to observe through <code class="highlighter-rouge">rollout history</code> that rollback to a specific revision was indeed performed</li>
</ul>

<h2 id="rolling-back-failures">Rolling Back Failures</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">set </span>image <span class="nt">-f</span> deploy/go-demo-2-api.yml <span class="se">\</span>
    <span class="nv">api</span><span class="o">=</span>vfarcic/go-demo-2:does-not-exist <span class="nt">--record</span>

kubectl get rs <span class="nt">-l</span> <span class="nb">type</span><span class="o">=</span>api

kubectl rollout status <span class="nt">-f</span> deploy/go-demo-2-api.yml

<span class="nb">echo</span> <span class="nv">$?</span>

kubectl rollout undo <span class="nt">-f</span> deploy/go-demo-2-api.yml

kubectl rollout status <span class="nt">-f</span> deploy/go-demo-2-api.yml
</code></pre></div></div>

<p>Note:
The output of the <code class="highlighter-rouge">set</code> command seems to imply that the <code class="highlighter-rouge">does-not-exist</code> image was successful deployed, when in fact it was not. Executing at <code class="highlighter-rouge">rollout status</code> confirms the deployment didn’t proceed. The new Pods are not running, and the limit was reached. There’s no point to continue trying. If you expected that the Deployment would roll back after it failed, you’re wrong. It will not do such a thing. At least, not without additional addons.  Running <code class="highlighter-rouge">echo $?</code>confirms the return code of the command is 1. Now that we witnessed the failure we can undo the rollout, and verify that our api is running.</p>

<h2 id="rolling-back-failures-1">Rolling Back Failures</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> deploy/go-demo-2-db.yml

kubectl delete <span class="nt">-f</span> deploy/go-demo-2-db-svc.yml

kubectl delete <span class="nt">-f</span> deploy/go-demo-2-api.yml
</code></pre></div></div>

<p>Note:
Now that we have learned how to rollback no matter whether the problem is a critical bug or inability to run the new release, we can take a short pause from learning new stuff and merge all the definitions we explored thus far into a single YAML file. But, before we do that, we’ll remove the objects we created.</p>

<h2 id="merging-everything">Merging Everything</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>deploy/go-demo-2.yml

kubectl create <span class="nt">-f</span> deploy/go-demo-2.yml <span class="nt">--record</span> <span class="nt">--save-config</span>

kubectl get <span class="nt">-f</span> deploy/go-demo-2.yml
</code></pre></div></div>

<p>Note:
If you start searching for differences with the previous definitions, you will find a few. The <code class="highlighter-rouge">minReadySeconds</code>, <code class="highlighter-rouge">progressDeadlineSeconds</code>, <code class="highlighter-rouge">revisionHistoryLimit</code>, and strategy fields are removed from the go-demo-2-api Deployment. We used them mostly as a way to demonstrate their usage. But, since Kubernetes has sensible defaults, we omitted them from this definition. You’ll also notice that there are two Services even though we created only one in this chapter. We did not need the go-demo-2-api Service in our examples since we didn’t need to access the API. But, for the sake of completeness, it is included in this definition. Finally, the strategy for deploying the database is set to <code class="highlighter-rouge">recreate</code>. As explained earlier, it is more suited for a single-replica database, even though we did not mount a volume that would preserve the data. Let’s create the objects defined in deploy/ go-demo-2. yml. Remember, with –save-config we’re making sure we can edit the configuration later. The alternative would be to use kubectl apply instead.</p>

<h2 id="updating-multiple-objects">Updating Multiple Objects</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>deploy/different-app-db.yml

kubectl create <span class="nt">-f</span> deploy/different-app-db.yml

kubectl get deployments <span class="nt">--show-labels</span>

kubectl get deployments <span class="nt">-l</span> <span class="nb">type</span><span class="o">=</span>db,vendor<span class="o">=</span>MongoLabs

kubectl <span class="nb">set </span>image deployments <span class="nt">-l</span> <span class="nb">type</span><span class="o">=</span>db,vendor<span class="o">=</span>MongoLabs <span class="se">\</span>
    <span class="nv">db</span><span class="o">=</span>mongo:3.4 <span class="nt">--record</span>

kubectl describe <span class="nt">-f</span> deploy/go-demo-2.yml
</code></pre></div></div>

<p>Note:
This this exercise we are creating another <code class="highlighter-rouge">db</code> applications. The purpose of this is to demonstrate how to update multiple objects using labels. Almost everything in Kubernetes is operated using label selectors. It’s just that sometimes that is obscured from us. We do not have to update an object only by specifying its name or the YAML file where its definition resides. We can also use labels to decide which object should be updated. That opens some interesting possibilities since the selectors might match multiple objects. Imagine that we are running several Deployments with Mongo databases and that the time has come to update them all to a newer release. Before we explore how we could do that, we’ll create another Deployment so that we have at least two with the database Pods. Here we are going to find all the deployments that are a <code class="highlighter-rouge">db</code> type, with <code class="highlighter-rouge">MongoLabs</code> vendor. Then we will update all the images that use those labels to a new version of mongo. Finally we will confirm that all mongo images are running <code class="highlighter-rouge">3.4</code></p>

<h2 id="scaling-deployments">Scaling Deployments</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>deploy/go-demo-2-scaled.yml

kubectl apply <span class="nt">-f</span> deploy/go-demo-2-scaled.yml

kubectl get <span class="nt">-f</span> deploy/go-demo-2-scaled.yml

kubectl scale deployment go-demo-2-api <span class="nt">--replicas</span> 8 <span class="nt">--record</span>

kubectl get <span class="nt">-f</span> deploy/go-demo-2.yml
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We created a few resources, including Deployment of the API with five replicas</li>
  <li>We retrieved the resources and observed that Deployment is indeed set to have five replicas</li>
  <li>We scaled the Deployment of the API to eight</li>
  <li>We retrieved the resources and observed that Deployment was changed to have eight replicas</li>
</ul>

<h2 id="deployments">Deployments</h2>

<hr />

<ul>
  <li>Zero-downtime updates<!-- .element: class="fragment" --></li>
</ul>

<!-- .slide: data-background="img/deploy-components.png" data-background-size="contain" -->

<h2 id="what-now">What Now?</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> deploy/go-demo-2.yml

kubectl delete <span class="nt">-f</span> deploy/different-app-db.yml
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/devops23/deploy-demo.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
