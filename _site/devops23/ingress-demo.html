<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hands-On Time | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hands-On Time" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/devops23/ingress-demo.html" />
<meta property="og:url" content="http://localhost:4000/devops23/ingress-demo.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/devops23/ingress-demo.html","@type":"WebPage","headline":"Hands-On Time","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h2 id="hands-on-time">Hands-On Time</h2>

<hr />

<h1 id="using-ingress-to-forward-traffic">Using Ingress To Forward Traffic</h1>

<h2 id="services-deficiencies">Services Deficiencies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
kubectl create <span class="nt">-f</span> ingress/go-demo-2-deploy.yml

<span class="c"># If EKS or GKE</span>
kubectl create <span class="nt">-f</span> ingress/go-demo-2-deploy-lb.yml

kubectl get <span class="nt">-f</span> ingress/go-demo-2-deploy.yml

kubectl get pods
</code></pre></div></div>

<p>Note:
We cannot explore solutions before we know what the problems are. Therefore, we’ll re-create a few objects using the knowledge we already gained. That will let us see whether Kubernetes Services satisfy all the needs users of our applications might have. Or, to be more explicit, we’ll explore which features we’re missing when making our applications accessible to users. We already discussed that it is a bad practice to publish fixed ports through Services. That method is likely to result in conflicts or, at the very least, create the additional burden of carefully keeping track of which port belongs to which Service. We already discarded that option before, and we won’t change our minds now. Since we’ve clarified that, let’s go back and create the Deployments and the Services from the previous chapter.</p>

<h2 id="services-deficiencies-1">Services Deficiencies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
<span class="nv">API_IP</span><span class="o">=</span><span class="k">$(</span>minikube ip<span class="k">)</span>

<span class="c"># If EKS</span>
<span class="nv">API_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get svc go-demo-2-api <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].hostname}"</span><span class="k">)</span>

<span class="c"># If GKE</span>
<span class="nv">API_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get svc go-demo-2-api <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].ip}"</span><span class="k">)</span>
</code></pre></div></div>

<p>Note:
We retrieved IP/address of the API Service</p>

<h2 id="services-deficiencies-2">Services Deficiencies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
<span class="nv">API_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl get svc go-demo-2-api <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].nodePort}"</span><span class="k">)</span>

<span class="c"># If EKS or GKE</span>
<span class="nv">API_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl get svc go-demo-2-api <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].port}"</span><span class="k">)</span>

curl <span class="nt">-i</span> <span class="s2">"http://</span><span class="nv">$API_IP</span><span class="s2">:</span><span class="nv">$API_PORT</span><span class="s2">/demo/hello"</span>
</code></pre></div></div>

<p>Note:
While publishing a random, or even a hard-coded port of a single application might not be so bad, if we’d apply the same principle to more applications, the user experience would be horrible. To make the point a bit clearer, we’ll deploy another application. In this exercise we will:</p>
<ul>
  <li>Retrieve port of the API Service</li>
  <li>Run a curl command and confirmed that it is accessible</li>
</ul>

<h2 id="services-deficiencies-3">Services Deficiencies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
kubectl create <span class="nt">-f</span> ingress/devops-toolkit-dep.yml <span class="se">\</span>
    <span class="nt">--record</span> <span class="nt">--save-config</span>

<span class="c"># If EKS or GKE</span>
kubectl create <span class="nt">-f</span> ingress/devops-toolkit-dep-lb.yml <span class="se">\</span>
    <span class="nt">--record</span> <span class="nt">--save-config</span>

kubectl get <span class="nt">-f</span> ingress/devops-toolkit-dep.yml
</code></pre></div></div>

<p>Note:
This is a second application being deployed inside the same cluster.</p>

<h2 id="services-deficiencies-4">Services Deficiencies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
<span class="nv">UI_IP</span><span class="o">=</span><span class="k">$(</span>minikube ip<span class="k">)</span>

<span class="c"># If EKS</span>
<span class="nv">UI_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get svc devops-toolkit <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].hostname}"</span><span class="k">)</span>

<span class="c"># If GKE</span>
<span class="nv">UI_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get svc devops-toolkit <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].ip}"</span><span class="k">)</span>
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We retrieved the IP/address of the UI</li>
</ul>

<h2 id="services-deficiencies-5">Services Deficiencies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
<span class="nv">UI_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl get svc devops-toolkit <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].nodePort}"</span><span class="k">)</span>

<span class="c"># If EKS or GKE</span>
<span class="nv">UI_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl get svc devops-toolkit <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].port}"</span><span class="k">)</span>
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We retrieved the port of the UI</li>
</ul>

<h2 id="services-deficiencies-6">Services Deficiencies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://</span><span class="nv">$UI_IP</span><span class="s2">:</span><span class="nv">$UI_PORT</span><span class="s2">"</span>

curl <span class="s2">"http://</span><span class="nv">$UI_IP</span><span class="s2">/demo/hello"</span>

curl <span class="nt">-i</span> <span class="nt">-H</span> <span class="s2">"Host: devopstoolkitseries.com"</span> <span class="s2">"http://</span><span class="nv">$UI_IP</span><span class="s2">"</span>
</code></pre></div></div>

<p>Note:
The <code class="highlighter-rouge">open</code> command should display The DevOps Toolkit Books page. If you don’t, you might want to wait a bit longer</p>
<ul>
  <li>We will also confirm that the API is NOT accessible without the port</li>
  <li>Finally, the UI is NOT accessible on a specific domain and without the port</li>
</ul>

<!-- .slide: data-background="img/services.png" data-background-size="contain" -->

<h2 id="enabling-ingress-minikube">Enabling Ingress (minikube)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
minikube addons list

<span class="c"># If minikube</span>
minikube addons <span class="nb">enable </span>ingress

<span class="nv">IP</span><span class="o">=</span><span class="k">$(</span>minikube ip<span class="k">)</span>
</code></pre></div></div>

<h2 id="enabling-ingress-minikube-1">Enabling Ingress (minikube)</h2>

<hr />

<ul>
  <li>We listed all the available minikube addons</li>
  <li>We enabled the <code class="highlighter-rouge">ingress</code> addon</li>
  <li>We retrieved the IP of the minikube VM</li>
</ul>

<h2 id="enabling-ingress-eks">Enabling Ingress (EKS)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="se">\</span>
    <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml

kubectl apply <span class="se">\</span>
    <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/aws/service-l4.yaml

kubectl apply <span class="se">\</span>
    <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/aws/patch-configmap-l4.yaml

<span class="nv">IP</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">-n</span> ingress-nginx get svc ingress-nginx <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].hostname}"</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$IP</span>

<span class="c"># Repeat if empty</span>
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We installed NGINX Ingress resources</li>
  <li>We retrieved the address of the ELB created by the Ingress Service</li>
</ul>

<h2 id="enabling-ingress-gke">Enabling Ingress (GKE)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="se">\</span>
    <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml

kubectl apply <span class="se">\</span>
    <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/cloud-generic.yaml

<span class="nv">IP</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">-n</span> ingress-nginx get svc ingress-nginx <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].ip}"</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$IP</span>

<span class="c"># Repeat if empty</span>
</code></pre></div></div>

<p>Note:</p>
<ul>
  <li>We installed NGINX Ingress resources</li>
  <li>We retrieved the address of the ELB created by the Ingress Service</li>
</ul>

<h2 id="enabling-ingress">Enabling Ingress</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">/healthz"</span>

curl <span class="nt">-i</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">/something"</span>
</code></pre></div></div>

<p>Note:
The <code class="highlighter-rouge">curl</code> command on <code class="highlighter-rouge">healthz</code> responded with the status code 200 OK, thus indicating that it is healthy and ready to serve requests. There’s not much more to it so we’ll move to the second endpoint. The Ingress Controller has a default catch-all endpoint that is used when a request does not match any of the other criteria. Since we did not yet create any Ingress Resource, this endpoint should provide the same response to all requests except /healthz.</p>

<h2 id="ingress-based-on-paths">Ingress Based On Paths</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>ingress/go-demo-2-ingress.yml

kubectl create <span class="nt">-f</span> ingress/go-demo-2-ingress.yml

kubectl get <span class="nt">-f</span> ingress/go-demo-2-ingress.yml

curl <span class="nt">-i</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">/demo/hello"</span>

kubectl delete <span class="nt">-f</span> ingress/go-demo-2-ingress.yml

kubectl delete <span class="nt">-f</span> ingress/go-demo-2-deploy.yml

kubectl delete <span class="nt">-f</span> ingress/devops-toolkit-dep.yml
</code></pre></div></div>

<p>Note:
Looking at the YAML file this time, metadata contains a field we haven’t used before. The annotations section allows us to provide additional information to the Ingress Controller. As you’ll see soon, Ingress API specification is concise and limited. That is done on purpose. The specification API defines only the fields that are mandatory for all Ingress Controllers. All the additional info an Ingress Controller needs is specified through annotations. That way, the community behind the Controllers can progress at great speed, while still providing basic general compatibility and standards. Here we will create Ingress resource tied to <code class="highlighter-rouge">go-demo-2-api</code> Service and <code class="highlighter-rouge">/demo</code> path. When we send a request to <code class="highlighter-rouge">/demo/hello</code> and got a response from the API. Then we can delete all the resources we created</p>

<h2 id="ingress-based-on-paths-1">Ingress Based On Paths</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>ingress/go-demo-2.yml

kubectl create <span class="nt">-f</span> ingress/go-demo-2.yml <span class="nt">--record</span> <span class="nt">--save-config</span>

curl <span class="nt">-i</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">/demo/hello"</span>
</code></pre></div></div>

<h2 id="ingress-based-on-paths-2">Ingress Based On Paths</h2>

<hr />

<ul>
  <li>We created all go-demo-2 resources from a single YAML file</li>
  <li>We confirmed that Ingress is working by sending a request</li>
</ul>

<!-- .slide: data-background="img/seq_ingress_ch07.png" data-background-size="contain" -->

<h2 id="ingress-based-on-paths-3">Ingress Based On Paths</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>ingress/devops-toolkit.yml

kubectl create <span class="nt">-f</span> ingress/devops-toolkit.yml <span class="nt">--record</span> <span class="nt">--save-config</span>

kubectl get ing

open <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">"</span>

curl <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">/demo/hello"</span>
</code></pre></div></div>

<h2 id="ingress-based-on-paths-4">Ingress Based On Paths</h2>

<hr />

<ul>
  <li>We created all UI resources from a single YAML file</li>
  <li>We listed Ingress resources and confirmed that both exist</li>
  <li>We opened UI in browser and sent a request to the API using the same address</li>
</ul>

<!-- .slide: data-background="img/ingress.png" data-background-size="contain" -->

<h2 id="ingress-based-on-domains">Ingress Based On Domains</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>ingress/devops-toolkit-dom.yml

kubectl apply <span class="nt">-f</span> ingress/devops-toolkit-dom.yml <span class="nt">--record</span>

curl <span class="nt">-I</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">"</span>

curl <span class="nt">-I</span> <span class="nt">-H</span> <span class="s2">"Host: devopstoolkitseries.com"</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">"</span>

curl <span class="nt">-H</span> <span class="s2">"Host: acme.com"</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">/demo/hello"</span>
</code></pre></div></div>

<h2 id="ingress-based-on-domains-1">Ingress Based On Domains</h2>

<hr />

<ul>
  <li>We changed UI Ingress to allow only requests from <em>devopstoolkitseries.com</em> domain</li>
  <li>We confirmed that a request without a domain returns <code class="highlighter-rouge">404 Not Found</code></li>
  <li>We confirmed that a request with the domain returns <code class="highlighter-rouge">200 OK</code></li>
  <li>We confirmed that <code class="highlighter-rouge">/demo/hello</code> is still accessible through any domain</li>
</ul>

<h2 id="ingress-with-default-backends">Ingress With Default Backends</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-I</span> <span class="nt">-H</span> <span class="s2">"Host: acme.com"</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">"</span>

<span class="nb">cat </span>ingress/default-backend.yml

kubectl create <span class="nt">-f</span> ingress/default-backend.yml

curl <span class="nt">-I</span> <span class="nt">-H</span> <span class="s2">"Host: acme.com"</span> <span class="s2">"http://</span><span class="nv">$IP</span><span class="s2">"</span>
</code></pre></div></div>

<h2 id="ingress-with-default-backends-1">Ingress With Default Backends</h2>

<hr />

<ul>
  <li>We confirmed that requests to a random domain return <code class="highlighter-rouge">404 Not Found</code></li>
  <li>We created a default (catch all) Ingress</li>
  <li>We confirmed that requests to a domain/path not covered by other Ingress rules are responded by the default Ingress</li>
</ul>

<!-- .slide: data-background="img/ingress-components.png" data-background-size="contain" -->

<h2 id="what-now">What Now?</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> ingress/default-backend.yml

kubectl delete <span class="nt">-f</span> ingress/devops-toolkit-dom.yml

kubectl delete <span class="nt">-f</span> ingress/go-demo-2.yml
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/devops23/ingress-demo.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
