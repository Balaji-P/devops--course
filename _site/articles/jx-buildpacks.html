<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Creating Custom Build Packs | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Creating Custom Build Packs" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/articles/jx-buildpacks.html" />
<meta property="og:url" content="http://localhost:4000/articles/jx-buildpacks.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/articles/jx-buildpacks.html","@type":"WebPage","headline":"Creating Custom Build Packs","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h1 id="creating-custom-build-packs">Creating Custom Build Packs</h1>

<p>I stand by my claim that “you do not need to understand Kubernetes to <strong>use Jenkins X</strong>.” To be more precise, those who do not want to know Kubernetes and its ecosystem in detail can benefit from Jenkins X ability to simplify the processes around software development lifecycle. That’s the promise or, at least, one of the driving ideas behind the project. Nevertheless, for that goal to reach as wide of an audience as possible, we need a variety of build packs. The more we have, the more use cases can be covered with a single <code class="highlighter-rouge">jx import</code> or <code class="highlighter-rouge">jx quickstart</code> command. The problem is that there is an infinite number of types of applications and combinations we might have. Not all can be covered with community-based packs. No matter how much effort the community puts into creating build packs, they will always be a fraction of what we might need. That’s where you come in.</p>

<p>The fact that Jenkins X build packs cannot fully cover all our use cases does not mean that we shouldn’t work on reducing the gap. Some of our applications will have a perfect match with one of the build packs. Others will require only slight modifications. Still, no matter how many packs we create, there will always be a case when the gap between what we need and what build packs offer is more significant.</p>

<p>Given the diversity in languages and frameworks we use to develop our applications, it is hard to avoid the need for understanding how to create new build packs. Those who want to expand the available build packs need to know at least basics behind Helm and a few other tools. Still, that does not mean that everyone needs to possess that knowledge. What we do not want is for different teams to reinvent the wheel and we do not wish for every developer to spend endless hours trying to figure out all the details behind the ever-growing Kubernetes ecosystem. It would be a waste of time for everyone to go through steps of importing their applications into Jenkins X, only to discover that they need to perform a set of changes to adapt the result to their own needs.</p>

<p>We’ll explore how to create a custom build pack that could be highly beneficial for a (fictional) company. We’ll imagine that there are multiple applications written in Go that depend on MongoDB and that there is a high probability that new ones based on the same stack will be created in the future. We’ll explore how to create such a build pack with the least possible effort.</p>

<blockquote>
  <p>I will assume that you already have a cluster with Jenkins X up-and-running. If that’s not the case, please consult the <a href="https://jenkins-x.io/">jenkins-x.io</a>.</p>
</blockquote>

<h2 id="creating-a-build-pack-for-go-applications-with-mongodb-datastore">Creating A Build Pack For Go Applications With MongoDB Datastore</h2>

<p>We are going to create a build pack that will facilitate the development and delivery of applications written in Go and with MongoDB as datastore. Given that there is already a pack for applications written in Go (without the DB), the easiest way to create what we need is by extending it. We’ll make a copy of the <code class="highlighter-rouge">go</code> build pack and add the things we’re missing.</p>

<p>The community-based packs are located in <code class="highlighter-rouge">~/.jx/draft/packs/github.com/jenkins-x-buildpacks/jenkins-x-kubernetes</code>. Or, to be more precise, that’s where those used with <em>Kubernetes Workloads</em> types are stored. Should we make a copy of the local <code class="highlighter-rouge">packs/go</code> directory? If we did that, our new pack would be available only on our laptop, and we would need to zip it and send it to others if they are to benefit from it. Since we are engineers, we should know better. All code goes to Git and build packs are not an exception.</p>

<p>If right now you are muttering to yourself something like “I don’t use Go, I don’t care”, just remember that the same principles apply if you use a different build pack as the base that will be extended to suit your needs. Think of this as a learning experience that can be applied to any build pack.</p>

<p>We’ll fork the repository with community build packs. That way, we’ll store our new pack safely to our repo. If we choose to, we’ll be able to make a pull request back to where we forked it from, and we’ll be able to tell Jenkins X to add that repository as the source of build packs. For now, we’ll concentrate on forking the repository.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"https://github.com/jenkins-x-buildpacks/jenkins-x-kubernetes"</span>
</code></pre></div></div>

<p>Please fork the repository by clicking the <em>Fork</em> button located in the top-right corner of the screen and follow the on-screen instructions.</p>

<p>Next, we’ll clone the newly forked repo.</p>

<p>W&gt; If you moved into this chapter straight after you finished reading the previous, you might still be in the local clone of the <em>go-demo-6</em> repository. If that’s the case, please go one directory back before cloning <code class="highlighter-rouge">jenkins-x-kubernetes</code>. Please execute <code class="highlighter-rouge">cd ..</code> first.</p>

<p>W&gt; Please replace <code class="highlighter-rouge">[...]</code> with your GitHub user before executing the commands that follow.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">GH_USER</span><span class="o">=[</span>...]

git clone https://github.com/<span class="nv">$GH_USER</span>/jenkins-x-kubernetes

<span class="nb">cd </span>jenkins-x-kubernetes
</code></pre></div></div>

<p>We cloned the newly forked repository and entered inside it.</p>

<p>Let’s see what we got inside the <code class="highlighter-rouge">packs</code> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-1</span> packs
</code></pre></div></div>

<p>The output is as follows.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>D
appserver
csharp
dropwizard
environment
go
gradle
imports.yaml
javascript
liberty
maven
maven-java11
php
python
ruby
rust
scala
swift
typescript
</code></pre></div></div>

<p>As you can see, those directories reflect the same choices as those presented to us when creating a Jenkins X quickstart or when importing existing projects.</p>

<p>I&gt; If you see <code class="highlighter-rouge">go-mongodb</code> in the list of directories, the <a href="https://github.com/jenkins-x-buildpacks/jenkins-x-kubernetes/pull/22">pull request</a> I made a while ago was accepted and merged to the main repository. Since we are practicing, using it would be cheating. Therefore, ignore its existence. I made sure that the name of the directory we’ll use (<code class="highlighter-rouge">go-mongo</code>) is different from the one I submitted in the PR (<code class="highlighter-rouge">go-mongodb</code>). That way, there will be no conflicts.</p>

<p>Let’s take a quick look at the <code class="highlighter-rouge">go</code> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-1</span> packs/go
</code></pre></div></div>

<p>The output is as follows.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dockerfile
Makefile
charts
pipeline.yaml
preview
skaffold.yaml
watch.sh
</code></pre></div></div>

<p>Those are the files Jenkins X uses to configure all the tools involved in the process that ultimately results in the deployment of a new release. We won’t dive into them just now. Instead, we’ll concentrate on the <code class="highlighter-rouge">charts</code> directory that contains the Helm chart that defines everything related to installation and updates of an application. I’ll let you explore it on your own. If you’re familiar with Helm, it should take you only a few minutes to understand the files it contains.</p>

<p>Since we’ll use <code class="highlighter-rouge">go</code> build pack as our baseline, our next step is to copy it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp <span class="nt">-R</span> packs/go packs/go-mongo
</code></pre></div></div>

<p>The first thing we’ll do is to add environment variable <code class="highlighter-rouge">DB</code> to the <code class="highlighter-rouge">charts/templates/deployment.yaml</code> file. Its purpose is to provide our application with the address of the database. That might not be your preferred way of retrieving the address so you might come up with a different solution for your applications. Nevertheless, it’s my application we’re using for this exercise, and that’s what it needs.</p>

<p>I won’t tell you to open your favorite editor and insert the changes. Instead, we’ll accomplish the same result with a bit of <code class="highlighter-rouge">sed</code> magic.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>packs/go-mongo/charts/templates/deployment.yaml <span class="se">\</span>
    | sed <span class="nt">-e</span> <span class="se">\</span>
    <span class="s1">'s@ports:@env:\
        - name: DB\
          value: -db\
        ports:@g'</span> <span class="se">\</span>
    | tee packs/go-mongo/charts/templates/deployment.yaml
</code></pre></div></div>

<p>The command we just executed added the <code class="highlighter-rouge">env</code> section right above <code class="highlighter-rouge">ports</code>. The modified output was used to replace the existing content of <code class="highlighter-rouge">deployment.yaml</code>.</p>

<p>The next in line of the files we have to change is the <code class="highlighter-rouge">requirements.yaml</code> file. That’s where we’ll add <code class="highlighter-rouge">mongodb</code> as a dependency of the Helm chart.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"dependencies:
- name: mongodb
  alias: code-db
  version: 5.3.0
  repository:  https://kubernetes-charts.storage.googleapis.com
"</span> | tee packs/go-mongo/charts/requirements.yaml
</code></pre></div></div>

<p>Please note the usage of the <code class="highlighter-rouge">code</code> string. Today (February 2019), that is still one of the features that are not documented. When the build pack is applied, it’ll replace that string with the actual name of the application. After all, it would be silly to hard-code the name of the application since this pack should be reusable across many.</p>

<p>Now that we created the <code class="highlighter-rouge">mongodb</code> dependency, we should add the values that will customize MongoDB chart so that the database is deployed as a MongoDB replica set (a Kubernetes StatefulSet with two or more replicas). The place where we change variables used with a chart is <code class="highlighter-rouge">values.yaml</code>. But, since we want to redefine values of dependency, we need to add it inside the name or, in our case, the alias of that dependency.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"code-db:
  replicaSet:
    enabled: true
"</span> | tee <span class="nt">-a</span> packs/go-mongo/charts/values.yaml
</code></pre></div></div>

<p>Just as with <code class="highlighter-rouge">requirements.yaml</code>, we used the “magic” string <code class="highlighter-rouge">code</code> that will be replaced with the name of the application during the import or the quickstart process. The <code class="highlighter-rouge">replicaSet.enabled</code> entry will make sure that the database is deployed as a multi-replica StatefulSet.</p>

<p>I&gt; If you’re interested in all the values available in the <code class="highlighter-rouge">mongodb</code> chart, please visit the <a href="https://github.com/helm/charts/tree/master/stable/mongodb">project README</a>.</p>

<p>You might think that we are finished with the changes, but that is not true. I wouldn’t blame you for that if you did not yet use Jenkins X with a pull request (PR). I’ll leave the explanation of how PRs work in Jenkins X for later. For now, it should be enough to know that the <code class="highlighter-rouge">preview</code> directory contains the template of the Helm chart that will be installed whenever we make a pull request and that we need to add <code class="highlighter-rouge">mongodb</code> there as well. The rest is on the need-to-know basis and reserved for the discussion of the flow of a Jenkins X PRs.</p>

<p>Let’s take a quick look at what we have in the <code class="highlighter-rouge">preview</code> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-1</span> packs/go-mongo/preview
</code></pre></div></div>

<p>The output is as follows.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chart.yaml
Makefile
requirements.yaml
values.yaml
</code></pre></div></div>

<p>As you can see, that is not a full-fledged Helm chart like the one we have in the <code class="highlighter-rouge">charts</code> directory. Instead, it relies on dependencies in <code class="highlighter-rouge">requirements.yaml</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>packs/go-mongo/preview/requirements.yaml
</code></pre></div></div>

<p>The output is as follows.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># !! File must end with empty line !!</span>
<span class="na">dependencies</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">expose</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">exposecontroller</span>
  <span class="na">repository</span><span class="pi">:</span> <span class="s">http://chartmuseum.jenkins-x.io</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">2.3.56</span>
<span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">cleanup</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">exposecontroller</span>
  <span class="na">repository</span><span class="pi">:</span> <span class="s">http://chartmuseum.jenkins-x.io</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">2.3.56</span>

  <span class="c1"># !! "alias: preview" must be last entry in dependencies array !!</span>
  <span class="c1"># !! Place custom dependencies above !!</span>
<span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">preview</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">code</span>
  <span class="na">repository</span><span class="pi">:</span> <span class="s">file://../code</span>
</code></pre></div></div>

<p>If we exclude the <code class="highlighter-rouge">exposecontroller</code> which we will ignore for now (it creates Ingress for our applications), the only dependency is the one aliased <code class="highlighter-rouge">preview</code>. It points to the directory where the application chart is located. As a result, whenever we create a preview (through a pull request), it’ll deploy the associated application. However, it will not install dependencies of that dependency, so we’ll need to add MongoDB there as well.</p>

<p>Just as before, the <code class="highlighter-rouge">preview</code> uses <code class="highlighter-rouge">code</code> tag instead of a hard-coded name of the application.</p>

<p>If you take a look at the comments, you’ll see that the file must end with an empty line. More importantly, the <code class="highlighter-rouge">preview</code> must be the last entry. That means that we need to add <code class="highlighter-rouge">mongodb</code> somewhere above it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>packs/go-mongo/preview/requirements.yaml <span class="se">\</span>
    | sed <span class="nt">-e</span> <span class="se">\</span>
    <span class="s1">'s@  # !! "alias@- name: mongodb\
  alias: preview-db\
  version: 5.3.0\
  repository:  https://kubernetes-charts.storage.googleapis.com\
\
  # !! "alias@g'</span> <span class="se">\</span>
    | tee packs/go-mongo/preview/requirements.yaml

<span class="nb">echo</span> <span class="s1">'
'</span> | tee <span class="nt">-a</span> packs/go-mongo/preview/requirements.yaml 
</code></pre></div></div>

<p>We performed a bit more <code class="highlighter-rouge">sed</code> of magic to add the <code class="highlighter-rouge">mongodb</code> dependency above the comment that starts with <code class="highlighter-rouge"># !! "alias</code>. Also, to be on the safe side, we added an empty line at the bottom as well.</p>

<p>Now we can push our changes to the forked repository.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>

git commit <span class="nt">-m</span> <span class="s2">"Added go-mongo build pack"</span>

git push
</code></pre></div></div>

<p>With the new build pack safely stored, we should let Jenkins X know that we want to use the forked repository.</p>

<p>We can use <code class="highlighter-rouge">jx edit buildpack</code> to change the location of our <code class="highlighter-rouge">kubernetes-workloads</code> packs. However, at the time of this writing (February 2019), there is a bug that prevents us from doing that (<a href="https://github.com/jenkins-x/jx/issues/2955">issue 2955</a>). The good news is that there is a workaround. If we omit the name (<code class="highlighter-rouge">-n</code> or <code class="highlighter-rouge">--name</code>), Jenkins X will add the new packs location, instead of editing the one dedicated to <code class="highlighter-rouge">kubernetes-workloads</code> packs.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jx edit buildpack <span class="se">\</span>
    <span class="nt">-u</span> https://github.com/<span class="nv">$GH_USER</span>/jenkins-x-kubernetes <span class="se">\</span>
    <span class="nt">-r</span> master <span class="se">\</span>
    <span class="nt">-b</span>
</code></pre></div></div>

<p>From now on, whenever we decide to create a new quickstart or to import a project, Jenkins X will use the packs from the forked repository <code class="highlighter-rouge">jenkins-x-kubernetes</code>.</p>

<p>Go ahead and try it out if you have a Go application with MongoDB at hand.</p>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/articles/jx-buildpacks.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
