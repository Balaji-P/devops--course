<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Automating Jenkins Docker Setup | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Automating Jenkins Docker Setup" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/articles/uber-jenkins.html" />
<meta property="og:url" content="http://localhost:4000/articles/uber-jenkins.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/articles/uber-jenkins.html","@type":"WebPage","headline":"Automating Jenkins Docker Setup","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h1 id="automating-jenkins-docker-setup">Automating Jenkins Docker Setup</h1>

<p>Jenkins is, by far, the most used CI/CD tool in the market. That comes as no surprise since it’s been around for a while, it has one of the biggest open source communities, it has enterprise version for those who need it, and it is straightforward to extend it to suit (almost) anyone’s needs.</p>

<p>Products that dominate the market for years tend to be stable and very feature rich. Jenkins is no exception. However, with age come some downsides as well. In the case of Jenkins, automation setup is one of the things that has a lot to be desired. If you need Jenkins to serve as an orchestrator of your automation and tasks, you’ll find it to be effortless to use. But, if you need to automate Jenkins itself, you’ll realize that it is not as smooth as you’d expect from modern tools. Never the less, Jenkins setup can be automated, and we’ll go through one possible solution.</p>

<p>I will not go through everything we can do as part of Jenkins setup. A whole book could be written on that subject. Instead, I’ll try to show you how to do two of the most common configuration steps. We’ll automate the installation of Jenkins plugins and setup of an administrator user. If you have a need to add more to the mix, please drop me an email (you’ll find my info on the <a href="https://technologyconversations.com/about/">About</a> page).</p>

<p>Let us quickly go through the objectives we’ll set in front of us.</p>

<h2 id="the-objectives">The Objectives</h2>

<p>Automation is the key to success of any software company. Since I believe that every company is a software company (even though some are still not aware of that), we can say that automation is the key for everyone.</p>

<p>I expect that you are using Docker to run your services. If you’re not, please reconsider your strategy. It provides so many benefits that ignoring it will mean that competition will overrun you. I won’t go into details why Docker is great. You probably already know all that.</p>

<p>The short version of the objectives behind automated Jenkins setup is that we do not want to do anything but run a single command. The result should be a fully configured Jenkins master that we can multiply to as many instances as we need. Docker, through Swarm, will provide fault tolerance, (kind of) high availability, and what so not.</p>

<p>A bit longer version is that we want to set up all the plugins we’ll need and create at least one administrative user. That does not mean that you will not add more plugins later. You probably will. However, that should not prevent us from pre-installing those that are most commonly used within your organization. Without at least one user, anyone could access your Jenkins master and, potentially, get access to your whole system. There is probably no need to discuss why we should avoid that.</p>

<p>Before we start working on automation, we’ll run a Jenkins master manually and fetch some information that will be useful later on.</p>

<h2 id="setting-up-jenkins-manually">Setting Up Jenkins Manually</h2>

<p>We’ll start by creating a Jenkins service inside a Swarm cluster. If you do not have one, you can easily convert your Docker for Windows/Mac/Linux to a single node cluster by executing <code class="highlighter-rouge">docker swarm init</code>.</p>

<p>W&gt; If you are a Windows user, please run all the commands from <em>Git Bash</em> (installed through <em>Git</em>) or any other Bash you might have.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service create <span class="nt">--name</span> jenkins <span class="se">\</span>
    <span class="nt">-p</span> 8080:8080 jenkins
</code></pre></div></div>

<p>After a while, <code class="highlighter-rouge">jenkins</code> image will be pulled, and the service will be running. Feel free to check the status by executing <code class="highlighter-rouge">docker service ps jenkins</code>.</p>

<p>Once Jenkins is up and running, we can open its UI in a browser.</p>

<blockquote>
  <p>If you’re a Windows user, Git Bash might not be able to use the <code class="highlighter-rouge">open</code> command. If that’s the case, replace <code class="highlighter-rouge">open</code> with <code class="highlighter-rouge">echo</code>. As a result, you’ll get the full address that should be opened directly in your browser of choice.</p>
</blockquote>

<blockquote>
  <p>If you’re not using your local Docker for Windows/Mac/Linux engine as the only node in the cluster, please replace <code class="highlighter-rouge">localhost</code> with the IP of one of your Swarm nodes.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://localhost:8080"</span>
</code></pre></div></div>

<p>You should see the first screen of the setup where you should enter the <em>Administrator password</em>. It is available inside the <code class="highlighter-rouge">/var/jenkins_home/secrets/initialAdminPassword</code> file inside the container that hosts the service.</p>

<blockquote>
  <p>If you’re not using your local Docker for Windows/Mac/Linux engine as the only node in the cluster, please find the node where the service is running and SSH into it before executing the commands that follow.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ID</span><span class="o">=</span><span class="k">$(</span>docker container <span class="nb">ls</span> <span class="nt">-q</span> <span class="se">\</span>
    <span class="nt">-f</span> <span class="s2">"label=com.docker.swarm.service.name=jenkins"</span><span class="k">)</span>

docker container <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$ID</span> <span class="se">\</span>
    <span class="nb">cat</span> /var/jenkins_home/secrets/initialAdminPassword
</code></pre></div></div>

<p>We used <code class="highlighter-rouge">docker container ls</code> command with a filter to find the ID of the container that hosts the service. Next, we executed a command that displayed content of the <code class="highlighter-rouge">/var/jenkins_home/secrets/initialAdminPassword</code> file. The output will vary from one execution to another. In my case, it is as follows.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ecd46df9ec1b420dadacdb56de9492c8
</code></pre></div></div>

<p>Please copy the password and paste it into the <em>Administrator password</em> field in Jenkins UI and follow the instructions to setup your Jenkins master. Choose the plugins that you’ll need. When you reach the last setup screen called <em>Create First Admin User</em>, please use <code class="highlighter-rouge">admin</code> as both the username and the password.</p>

<p>Once the setup is finished, we can send a request that will retrieve the list of all the plugins we installed.</p>

<blockquote>
  <p>Before we proceed, please check whether you have <em>jq</em> installed. If you don’t, you can find on in its <a href="https://stedolan.github.io/jq/">official site</a>.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -s -k "http://admin:admin@localhost:8080/pluginManager/api/json?depth=1" \
  | jq -r '.plugins[].shortName' | tee plugins.txt
</code></pre></div></div>

<p>We sent a request to the Jenkins plugin manager API and retrieved all the plugins we installed during the manual setup. We piped the result to <em>jq</em> and filtered it in a way that only short names are output. The result is stored in the <em>plugins.txt</em> file.</p>

<p>We don’t need Jenkins service anymore. It has only a temporary function that allowed us to retrieve the list of plugins we’ll need. Let’s destroy it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service rm jenkins
</code></pre></div></div>

<h2 id="creating-jenkins-image-with-automated-setup">Creating Jenkins Image With Automated Setup</h2>

<p>Before we define Dockerfile that we’ll use to create Jenkins image with automatic setup, we need to figure out how to create at least one administrative user. Unfortunately, there is no (decent) API we can invoke. Our best bet is to execute a Groovy script that will do the job. The script is as follows.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="o">!</span><span class="n">groovy</span>

<span class="kn">import</span> <span class="nn">jenkins.model.*</span>
<span class="kn">import</span> <span class="nn">hudson.security.*</span>
<span class="kn">import</span> <span class="nn">jenkins.security.s2m.AdminWhitelistRule</span>

<span class="kt">def</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">Jenkins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()</span>

<span class="kt">def</span> <span class="n">hudsonRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HudsonPrivateSecurityRealm</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
<span class="n">hudsonRealm</span><span class="o">.</span><span class="na">createAccount</span><span class="o">(</span><span class="s2">"admin"</span><span class="o">,</span> <span class="s2">"admin"</span><span class="o">)</span>
<span class="n">instance</span><span class="o">.</span><span class="na">setSecurityRealm</span><span class="o">(</span><span class="n">hudsonRealm</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">strategy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FullControlOnceLoggedInAuthorizationStrategy</span><span class="o">()</span>
<span class="n">instance</span><span class="o">.</span><span class="na">setAuthorizationStrategy</span><span class="o">(</span><span class="n">strategy</span><span class="o">)</span>
<span class="n">instance</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>

<span class="n">Jenkins</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">getInjector</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">AdminWhitelistRule</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">setMasterKillSwitch</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</code></pre></div></div>

<p>The key is in the <code class="highlighter-rouge">hudsonRealm.createAccount("admin", "admin")</code> line. It creates an account with both username and password set to <code class="highlighter-rouge">admin</code>.</p>

<p>The major problem with that script is that it has the credentials hard-coded. We could convert them to environment variables, but that would be very insecure. Instead, we’ll leverage Docker secrets. When attached to a container, secrets are stored in <code class="highlighter-rouge">/run/secrets</code> in-memory directory.</p>

<p>More secure (and flexible) version of the script is as follows.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="o">!</span><span class="n">groovy</span>

<span class="kn">import</span> <span class="nn">jenkins.model.*</span>
<span class="kn">import</span> <span class="nn">hudson.security.*</span>
<span class="kn">import</span> <span class="nn">jenkins.security.s2m.AdminWhitelistRule</span>

<span class="kt">def</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">Jenkins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()</span>

<span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s2">"/run/secrets/jenkins-user"</span><span class="o">).</span><span class="na">text</span><span class="o">.</span><span class="na">trim</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">pass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s2">"/run/secrets/jenkins-pass"</span><span class="o">).</span><span class="na">text</span><span class="o">.</span><span class="na">trim</span><span class="o">()</span>

<span class="kt">def</span> <span class="n">hudsonRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HudsonPrivateSecurityRealm</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
<span class="n">hudsonRealm</span><span class="o">.</span><span class="na">createAccount</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">pass</span><span class="o">)</span>
<span class="n">instance</span><span class="o">.</span><span class="na">setSecurityRealm</span><span class="o">(</span><span class="n">hudsonRealm</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">strategy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FullControlOnceLoggedInAuthorizationStrategy</span><span class="o">()</span>
<span class="n">instance</span><span class="o">.</span><span class="na">setAuthorizationStrategy</span><span class="o">(</span><span class="n">strategy</span><span class="o">)</span>
<span class="n">instance</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>

<span class="n">Jenkins</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">getInjector</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">AdminWhitelistRule</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">setMasterKillSwitch</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</code></pre></div></div>

<p>This time, we placed contents of <code class="highlighter-rouge">jenkins-user</code> and <code class="highlighter-rouge">jenkins-pass</code> files into variables and used them to create an account.</p>

<p>Please save the script as <code class="highlighter-rouge">security.groovy</code> file.</p>

<p>Equipped with the list of plugins stored in <code class="highlighter-rouge">plugins.txt</code> and the script that will create a user from Docker secrets, we can proceed and create a Dockerfile.</p>

<p>Please create <code class="highlighter-rouge">Dockerfile</code> with the content that follows.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM jenkins:alpine

ENV JAVA_OPTS="-Djenkins.install.runSetupWizard=false"

COPY security.groovy /usr/share/jenkins/ref/init.groovy.d/security.groovy

COPY plugins.txt /usr/share/jenkins/ref/plugins.txt
RUN /usr/local/bin/install-plugins.sh &lt; /usr/share/jenkins/ref/plugins.txt
</code></pre></div></div>

<p>The image will be based on <code class="highlighter-rouge">alpine</code> version of Jenkins which is much smaller and more secure than others.</p>

<p>We used <code class="highlighter-rouge">JAVA_OPTS</code> to disable the setup wizard. We won’t need it since our setup will be fully automated.</p>

<p>Next, we’re copying the <code class="highlighter-rouge">security.groovy</code> file into <code class="highlighter-rouge">/usr/share/jenkins/ref/init.groovy.d/</code> directory. Jenkins, when initialized, will execute all the Groovy scripts located in that directory. If you create additional setup scripts, that is the place you should place them.</p>

<p>Finally, we are copying the <code class="highlighter-rouge">plugins.txt</code> file that contains the list of all the plugins we need and passing that list to the <code class="highlighter-rouge">install-plugins.sh</code> script which is part of the standard distribution.</p>

<p>With the <code class="highlighter-rouge">Dockerfile</code> defined, we can build our image and push it to Docker registry.</p>

<blockquote>
  <p>Please replace <code class="highlighter-rouge">vfarcic</code> with your Docker Hub user.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build <span class="nt">-t</span> vfarcic/jenkins <span class="nb">.</span>

docker image push vfarcic/jenkins
</code></pre></div></div>

<p>With the image built and pushed to the Registry, we can, finally, create a Jenkins service.</p>

<h2 id="creating-jenkins-service-with-automated-setup">Creating Jenkins Service With Automated Setup</h2>

<p>We should create a Compose file that will hold the definition of the service. It is as follows.</p>

<blockquote>
  <p>Please replace <code class="highlighter-rouge">vfarcic</code> with your Docker Hub user.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '3.1'

services:

  main:
    image: vfarcic/jenkins
    ports:
      - 8080:8080
      - 50000:50000
    secrets:
      - jenkins-user
      - jenkins-pass

secrets:
  jenkins-user:
    external: true
  jenkins-pass:
    external: true
</code></pre></div></div>

<p>Save the definition as <code class="highlighter-rouge">jenkins.yml</code> file.</p>

<p>The Compose file is very straightforward. If defines only one service (<code class="highlighter-rouge">main</code>) and uses the newly built image. It is exposing ports <code class="highlighter-rouge">8080</code> for the UI and <code class="highlighter-rouge">50000</code> for the agents. Finally, it defines <code class="highlighter-rouge">jenkins-user</code> and <code class="highlighter-rouge">jenkins-pass</code> secrets.</p>

<p>We should create the secrets before deploying the stack. The commands that follow will use <code class="highlighter-rouge">admin</code> as both the username and the password. Feel free to change it to something less obvious.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"admin"</span> | docker secret create jenkins-user -

<span class="nb">echo</span> <span class="s2">"admin"</span> | docker secret create jenkins-pass -
</code></pre></div></div>

<p>Now we are ready to deploy the stack.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack deploy <span class="nt">-c</span> jenkins.yml jenkins
</code></pre></div></div>

<p>A few moments later, the service will be up and running. Please confirm the status by executing <code class="highlighter-rouge">docker stack ps jenkins</code>.</p>

<p>Let’s confirm that everything works as expected.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://localhost:8080"</span>
</code></pre></div></div>

<p>You’ll notice that this time, we did not have to go through the Setup Wizard steps. Everything is automated and the service is ready for use. Feel free to log in and confirm that the user you specified is indeed created.</p>

<p>If you create this service in a demo environment (e.g. your laptop) now is the time to remove it and free your resources for something else. The image you just built should be ready for production.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack rm jenkins

docker secret rm jenkins-user

docker secret rm jenkins-pass
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/articles/uber-jenkins.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
