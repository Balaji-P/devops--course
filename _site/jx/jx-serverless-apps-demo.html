<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hands-On Time | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hands-On Time" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/jx/jx-serverless-apps-demo.html" />
<meta property="og:url" content="http://localhost:4000/jx/jx-serverless-apps-demo.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/jx/jx-serverless-apps-demo.html","@type":"WebPage","headline":"Hands-On Time","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h2 id="hands-on-time">Hands-On Time</h2>

<hr />

<h1 id="defining-and-running-serverless-deployments">Defining And Running Serverless Deployments</h1>

<h2 id="installing-gloo-and-knative">Installing Gloo and Knative</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jx create addon gloo

kubectl get namespaces

jx edit deploy <span class="nt">--team</span> <span class="nt">--kind</span> default <span class="nt">--batch-mode</span>

jx edit deploy <span class="nt">--team</span> <span class="nt">--kind</span> knative <span class="nt">--batch-mode</span>
</code></pre></div></div>

<h2 id="new-serverless-application">New Serverless Application</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jx create quickstart <span class="nt">--language</span> go <span class="nt">--project-name</span> jx-knative <span class="se">\</span>
    <span class="nt">--batch-mode</span>

<span class="nb">cd </span>jx-knative

<span class="nb">cat </span>charts/jx-knative/values.yaml

<span class="nb">ls</span> <span class="nt">-1</span> charts/jx-knative/templates

<span class="nb">cat </span>charts/jx-knative/templates/deployment.yaml

<span class="nb">cat </span>charts/jx-knative/templates/ksvc.yaml

jx get activities <span class="nt">--filter</span> jx-knative <span class="nt">--watch</span>

jx get activities <span class="nt">--filter</span> environment-tekton-staging/master <span class="nt">--watch</span>
</code></pre></div></div>

<h2 id="new-serverless-application-1">New Serverless Application</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative

kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> describe pod <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative

kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get all

jx get applications <span class="nt">--env</span> staging

<span class="nv">ADDR</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get ksvc jx-knative <span class="se">\</span>
    <span class="nt">--output</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.domain}"</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$ADDR</span>

curl <span class="s2">"</span><span class="nv">$ADDR</span><span class="s2">"</span>
</code></pre></div></div>

<h2 id="new-serverless-application-2">New Serverless Application</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative

kubectl <span class="nt">--namespace</span> cd-staging get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative

kubectl <span class="nt">--namespace</span> knative-serving <span class="se">\</span>
    describe configmap config-autoscaler

kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative

<span class="c"># Make sure that the output is `no resources found`</span>
</code></pre></div></div>

<h2 id="new-serverless-application-3">New Serverless Application</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run siege <span class="nt">--image</span> yokogawa/siege <span class="nt">--generator</span> <span class="s2">"run-pod/v1"</span> <span class="se">\</span>
     <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--</span> <span class="nt">-c</span> 300 <span class="nt">-t</span> 20S <span class="s2">"http://</span><span class="nv">$ADDR</span><span class="s2">/"</span> <span class="se">\</span>
     <span class="o">&amp;&amp;</span> kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative

<span class="nb">cat </span>charts/jx-knative/templates/ksvc.yaml | sed <span class="nt">-e</span> <span class="se">\</span>
    <span class="s1">'s@revisionTemplate:@revisionTemplate:\
        metadata:\
          annotations:\
            autoscaling.knative.dev/target: "3"\
            autoscaling.knative.dev/maxScale: "5"@g'</span> <span class="se">\</span>
    | tee charts/jx-knative/templates/ksvc.yaml
</code></pre></div></div>

<h2 id="new-serverless-application-4">New Serverless Application</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>

git commit <span class="nt">-m</span> <span class="s2">"Added Knative target"</span>

git push

jx get activities <span class="nt">--filter</span> jx-knative <span class="nt">--watch</span>

jx get activities <span class="nt">--filter</span> environment-tekton-staging/master <span class="nt">--watch</span>

curl <span class="s2">"http://</span><span class="nv">$ADDR</span><span class="s2">/"</span>

kubectl run siege <span class="nt">--image</span> yokogawa/siege <span class="nt">--generator</span> <span class="s2">"run-pod/v1"</span> <span class="se">\</span>
     <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--</span> <span class="nt">-c</span> 400 <span class="nt">-t</span> 60S <span class="s2">"http://</span><span class="nv">$ADDR</span><span class="s2">/"</span> <span class="se">\</span>
     <span class="o">&amp;&amp;</span> kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative
</code></pre></div></div>

<h2 id="new-serverless-application-5">New Serverless Application</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative

<span class="nb">cat </span>charts/jx-knative/templates/ksvc.yaml | sed <span class="nt">-e</span> <span class="se">\</span>
    <span class="s1">'s@autoscaling.knative.dev/target: "3"@autoscaling.knative.dev/target: "3"\
            autoscaling.knative.dev/minScale: "1"@g'</span> <span class="se">\</span>
    | tee charts/jx-knative/templates/ksvc.yaml

git add <span class="nb">.</span>

git commit <span class="nt">-m</span> <span class="s2">"Added Knative minScale"</span>

git push

jx get activities <span class="nt">--filter</span> jx-knative <span class="nt">--watch</span>

jx get activities <span class="nt">--filter</span> environment-tekton-staging/master <span class="nt">--watch</span>
</code></pre></div></div>

<h2 id="new-serverless-application-6">New Serverless Application</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods <span class="se">\</span>
    <span class="nt">--selector</span> serving.knative.dev/service<span class="o">=</span>jx-knative
</code></pre></div></div>

<h2 id="existing-projects-to-serverless">Existing Projects To Serverless</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ../go-demo-6

git checkout <span class="nt">-b</span> serverless

<span class="nb">ls</span> <span class="nt">-1</span> charts/go-demo-6/templates
</code></pre></div></div>

<h3 id="adding-knative-support-manually">Adding Knative Support Manually</h3>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"knativeDeploy: false"</span> | tee <span class="nt">-a</span> charts/go-demo-6/values.yaml

<span class="nb">echo</span> <span class="s2">"
</span><span class="k">$(</span><span class="nb">cat </span>charts/go-demo-6/templates/deployment.yaml<span class="k">)</span><span class="s2">"</span> | tee charts/go-demo-6/templates/deployment.yaml

<span class="nb">echo</span> <span class="s2">"
</span><span class="k">$(</span><span class="nb">cat </span>charts/go-demo-6/templates/service.yaml<span class="k">)</span><span class="s2">"</span> | tee charts/go-demo-6/templates/service.yaml

curl <span class="nt">-o</span> tee charts/go-demo-6/templates/ksvc.yaml <span class="se">\</span>
    https://gist.githubusercontent.com/vfarcic/cb7c79f25e65bcca5f6e553a2aa8a47c/raw/886508339a4c04b9e575b6f4d417e80018e4c3f6/ksvc.yaml
</code></pre></div></div>

<h3 id="turning-on-knative-support">Turning On Knative Support</h3>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jx edit deploy knative

<span class="nb">cat </span>charts/go-demo-6/values.yaml | <span class="nb">grep </span>knative
</code></pre></div></div>

<h3 id="adding-the-final-touches">Adding The Final Touches</h3>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>charts/go-demo-6/Makefile | sed <span class="nt">-e</span> <span class="s2">"s@vfarcic@</span><span class="nv">$PROJECT</span><span class="s2">@g"</span> <span class="se">\</span>
    | tee charts/go-demo-6/Makefile

<span class="nb">cat </span>charts/preview/Makefile | sed <span class="nt">-e</span> <span class="s2">"s@vfarcic@</span><span class="nv">$PROJECT</span><span class="s2">@g"</span> <span class="se">\</span>
    | tee charts/preview/Makefile

<span class="nb">cat </span>skaffold.yaml | sed <span class="nt">-e</span> <span class="s2">"s@vfarcic@</span><span class="nv">$PROJECT</span><span class="s2">@g"</span> | tee skaffold.yaml

<span class="nb">cat </span>jenkins-x.yml | sed <span class="s1">'$ d'</span> | tee jenkins-x.yml

curl <span class="nt">-o</span> Jenkinsfile https://gist.githubusercontent.com/vfarcic/56c986a29e0753076e08163a7c6a2051/raw/a8be26f33c877c0927e833b015c5620d150712d6/Jenkinsfile

git add <span class="nb">.</span>

git commit <span class="nt">-m</span> <span class="s2">"Added Knative"</span>

git push <span class="nt">--set-upstream</span> origin serverless
</code></pre></div></div>

<h2 id="serverless-with-prs">Serverless With PRs</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jx create pullrequest <span class="nt">--title</span> <span class="s2">"Serverless with Knative"</span> <span class="se">\</span>
    <span class="nt">--body</span> <span class="s2">"What I can say?"</span> <span class="nt">--batch-mode</span>

<span class="nv">BRANCH</span><span class="o">=[</span>...] <span class="c"># e.g., `PR-109`</span>

jx get activities <span class="nt">--filter</span> go-demo-6/<span class="nv">$BRANCH</span> <span class="nt">--watch</span>

<span class="nv">GH_USER</span><span class="o">=[</span>...]

<span class="nv">PR_NAMESPACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$NAMESPACE</span>-<span class="nv">$GH_USER</span><span class="nt">-go-demo-6-</span><span class="nv">$BRANCH</span> <span class="se">\</span>
  | tr <span class="s1">'[:upper:]'</span> <span class="s1">'[:lower:]'</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$PR_NAMESPACE</span>

kubectl <span class="nt">--namespace</span> <span class="nv">$PR_NAMESPACE</span> get pods
</code></pre></div></div>

<h2 id="serverless-with-prs-1">Serverless With PRs</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PR_ADDR</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">--namespace</span> <span class="nv">$PR_NAMESPACE</span> get ksvc go-demo-6 <span class="se">\</span>
    <span class="nt">--output</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.domain}"</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$PR_ADDR</span>

curl <span class="s2">"</span><span class="nv">$PR_ADDR</span><span class="s2">/demo/hello"</span>

kubectl <span class="nt">--namespace</span> cd-staging get pods

jx repo

<span class="c"># Merge the PR</span>
</code></pre></div></div>

<h2 id="serverless-with-prs-2">Serverless With PRs</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout master

git branch <span class="nt">-d</span> serverless

git pull

jx get activities <span class="nt">--filter</span> go-demo-6/master <span class="nt">--watch</span>

jx get activities <span class="nt">--filter</span> environment-tekton-staging/master <span class="nt">--watch</span>

kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods
</code></pre></div></div>

<h2 id="serverless-with-prs-3">Serverless With PRs</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ADDR</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get ksvc go-demo-6 <span class="se">\</span>
    <span class="nt">--output</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.domain}"</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$ADDR</span>

curl <span class="s2">"</span><span class="nv">$ADDR</span><span class="s2">/demo/hello"</span>
</code></pre></div></div>

<h2 id="serverless-with-prs-only">Serverless With PRs Only</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">STAGING_ENV</span><span class="o">=</span>environment-tekton-staging

<span class="nb">cd</span> ..

rm <span class="nt">-rf</span> <span class="nv">$STAGING_ENV</span>

git clone https://github.com/<span class="nv">$GH_USER</span>/<span class="nv">$STAGING_ENV</span>.git

<span class="nb">cd</span> <span class="nv">$STAGING_ENV</span>

<span class="nb">echo</span> <span class="s2">"go-demo-6:
  knativeDeploy: false"</span> | tee <span class="nt">-a</span> env/values.yaml
</code></pre></div></div>

<h2 id="serverless-with-prs-only-1">Serverless With PRs Only</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>

git commit <span class="nt">-m</span> <span class="s2">"Removed Knative"</span>

git pull

git push
</code></pre></div></div>

<h2 id="serverless-with-prs-only-2">Serverless With PRs Only</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ../go-demo-6

<span class="nb">echo</span> <span class="s2">"go-demo-6 rocks"</span> | tee README.md

git add <span class="nb">.</span>

git commit <span class="nt">-m</span> <span class="s2">"Removed Knative"</span>

git pull

git push

jx get activities <span class="nt">--filter</span> go-demo-6/master <span class="nt">--watch</span>

jx get activities <span class="nt">--filter</span> environment-tekton-staging/master <span class="nt">--watch</span>

kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get pods
</code></pre></div></div>

<h2 id="serverless-with-prs-only-3">Serverless With PRs Only</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ADDR</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">--namespace</span> <span class="nv">$NAMESPACE</span><span class="nt">-staging</span> get ing go-demo-6 <span class="se">\</span>
    <span class="nt">--output</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.rules[0].host}"</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$ADDR</span>

curl <span class="s2">"</span><span class="nv">$ADDR</span><span class="s2">/demo/hello"</span>
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/jx/jx-serverless-apps-demo.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
