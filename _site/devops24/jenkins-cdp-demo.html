<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hands-On Time | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hands-On Time" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/devops24/jenkins-cdp-demo.html" />
<meta property="og:url" content="http://localhost:4000/devops24/jenkins-cdp-demo.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/devops24/jenkins-cdp-demo.html","@type":"WebPage","headline":"Hands-On Time","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h2 id="hands-on-time">Hands-On Time</h2>

<hr />

<h1 id="creating-a-cdp-pipeline-with-jenkins">Creating A CDP Pipeline With Jenkins</h1>

<!-- .slide: data-background="img/cdp-stages.png" data-background-size="contain" -->

<h2 id="defining-the-build-stage">Defining The Build Stage</h2>

<hr />

<!-- .slide: data-background="img/cdp-stages-build.png" data-background-size="contain" -->

<h2 id="defining-the-build-stage-1">Defining The Build Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">"</span>
</code></pre></div></div>

<ul>
  <li>Create a Pipeline job called <em>go-demo-3</em></li>
</ul>

<h2 id="defining-the-build-stage-2">Defining The Build Stage</h2>

<hr />

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span>

<span class="n">currentBuild</span><span class="o">.</span><span class="na">displayName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"yy.MM.dd"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">BUILD_NUMBER</span>
<span class="n">env</span><span class="o">.</span><span class="na">REPO</span> <span class="o">=</span> <span class="s2">"https://github.com/vfarcic/go-demo-3.git"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">IMAGE</span> <span class="o">=</span> <span class="s2">"vfarcic/go-demo-3"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">TAG_BETA</span> <span class="o">=</span> <span class="s2">"${currentBuild.displayName}-${env.BRANCH_NAME}"</span>

<span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">stage</span><span class="o">(</span><span class="s2">"build"</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
    <span class="n">sh</span> <span class="s2">"sudo docker image build -t ${env.IMAGE}:${env.TAG_BETA} ."</span>
    <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"docker"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
      <span class="n">sh</span> <span class="s2">"sudo docker login -u $USER -p $PASS"</span>
    <span class="o">}</span>
    <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:${env.TAG_BETA}"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="defining-the-build-stage-3">Defining The Build Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">DH_USER</span><span class="o">=[</span>...]

open <span class="s2">"https://hub.docker.com/r/</span><span class="nv">$DH_USER</span><span class="s2">/go-demo-3/tags/"</span>
</code></pre></div></div>

<h2 id="the-functional-testing-stage">The Functional Testing Stage</h2>

<hr />

<!-- .slide: data-background="img/cdp-stages-func.png" data-background-size="contain" -->

<h2 id="the-functional-testing-stage-1">The Functional Testing Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">ADDR</span><span class="o">=</span><span class="nv">$LB_IP</span>.nip.io

<span class="nb">echo</span> <span class="nv">$ADDR</span>

open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/job/go-demo-3/configure"</span>
</code></pre></div></div>

<h2 id="the-functional-testing-stage-2">The Functional Testing Stage</h2>

<hr />

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span>

<span class="n">currentBuild</span><span class="o">.</span><span class="na">displayName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"yy.MM.dd"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">BUILD_NUMBER</span>
<span class="n">env</span><span class="o">.</span><span class="na">REPO</span> <span class="o">=</span> <span class="s2">"https://github.com/vfarcic/go-demo-3.git"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">IMAGE</span> <span class="o">=</span> <span class="s2">"vfarcic/go-demo-3"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">ADDRESS</span> <span class="o">=</span> <span class="s2">"go-demo-3-${env.BUILD_NUMBER}-${env.BRANCH_NAME}.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">TAG_BETA</span> <span class="o">=</span> <span class="s2">"${currentBuild.displayName}-${env.BRANCH_NAME}"</span>
<span class="n">env</span><span class="o">.</span><span class="na">CHART_NAME</span> <span class="o">=</span> <span class="s2">"go-demo-3-${env.BUILD_NUMBER}-${env.BRANCH_NAME}"</span>
<span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"jenkins-slave-${UUID.randomUUID().toString()}"</span>

<span class="n">podTemplate</span><span class="o">(</span>
  <span class="nl">label:</span> <span class="n">label</span><span class="o">,</span>
  <span class="nl">namespace:</span> <span class="s2">"go-demo-3-build"</span><span class="o">,</span>
  <span class="nl">serviceAccount:</span> <span class="s2">"build"</span><span class="o">,</span>
  <span class="nl">yaml:</span> <span class="s2">"""
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: helm
    image: vfarcic/helm:2.9.1
    command: ["cat"]
    tty: true
  - name: kubectl
    image: vfarcic/kubectl
    command: ["cat"]
    tty: true
  - name: golang
    image: golang:1.9
    command: ["cat"]
    tty: true
"""</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="n">node</span><span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s2">"build"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image build -t ${env.IMAGE}:${env.TAG_BETA} ."</span>
        <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"docker"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"sudo docker login -u $USER -p $PASS"</span>
        <span class="o">}</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:${env.TAG_BETA}"</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"func-test"</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
          <span class="n">sh</span> <span class="s2">"helm upgrade ${env.CHART_NAME} helm/go-demo-3 -i --tiller-namespace go-demo-3-build --set image.tag=${env.TAG_BETA} --set ingress.host=${env.ADDRESS} --set replicaCount=2 --set dbReplicaCount=1"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"kubectl"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"kubectl -n go-demo-3-build rollout status deployment ${env.CHART_NAME}"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"golang"</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Uses env ADDRESS</span>
          <span class="n">sh</span> <span class="s2">"go get -d -v -t"</span>
          <span class="n">sh</span> <span class="s2">"go test ./... -v --run FunctionalTest"</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">error</span> <span class="s2">"Failed functional tests"</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"helm delete ${env.CHART_NAME} --tiller-namespace go-demo-3-build --purge"</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="the-functional-testing-stage-3">The Functional Testing Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">ls</span> <span class="nt">--tiller-namespace</span> go-demo-3-build

kubectl <span class="nt">-n</span> go-demo-3-build get pods

<span class="c"># Wait until the build is finished</span>

helm <span class="nb">ls</span> <span class="nt">--tiller-namespace</span> go-demo-3-build

kubectl <span class="nt">-n</span> go-demo-3-build get pods
</code></pre></div></div>

<h2 id="defining-the-release-stage">Defining The Release Stage</h2>

<hr />

<!-- .slide: data-background="img/cdp-stages-release.png" data-background-size="contain" -->

<h2 id="defining-the-release-stage-1">Defining The Release Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/credentials/store/system/domain/_/newCredentials"</span>
</code></pre></div></div>

<ul>
  <li>Type <em>admin</em> as both the <em>Username</em> and the <em>Password</em></li>
  <li>Set the <em>ID</em> and the <em>Description</em> to <em>chartmuseum</em></li>
  <li>Click the <em>OK</em> button to persist the credentials.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">JENKINS_POD</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">-n</span> jenkins get pods <span class="se">\</span>
    <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>jenkins-jenkins-master <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$JENKINS_POD</span>

kubectl <span class="nt">-n</span> jenkins cp <span class="se">\</span>
    <span class="nv">$JENKINS_POD</span>:var/jenkins_home/credentials.xml cluster/jenkins

<span class="nb">echo</span> <span class="nv">$ADDR</span>

open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/job/go-demo-3/configure"</span>
</code></pre></div></div>

<h2 id="defining-the-release-stage-2">Defining The Release Stage</h2>

<hr />

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span>

<span class="n">currentBuild</span><span class="o">.</span><span class="na">displayName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"yy.MM.dd"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">BUILD_NUMBER</span>
<span class="n">env</span><span class="o">.</span><span class="na">REPO</span> <span class="o">=</span> <span class="s2">"https://github.com/vfarcic/go-demo-3.git"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">IMAGE</span> <span class="o">=</span> <span class="s2">"vfarcic/go-demo-3"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">ADDRESS</span> <span class="o">=</span> <span class="s2">"go-demo-3-${env.BUILD_NUMBER}-${env.BRANCH_NAME}.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">CM_ADDR</span> <span class="o">=</span> <span class="s2">"cm.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">TAG</span> <span class="o">=</span> <span class="s2">"${currentBuild.displayName}"</span>
<span class="n">env</span><span class="o">.</span><span class="na">TAG_BETA</span> <span class="o">=</span> <span class="s2">"${env.TAG}-${env.BRANCH_NAME}"</span>
<span class="n">env</span><span class="o">.</span><span class="na">CHART_VER</span> <span class="o">=</span> <span class="s2">"0.0.1"</span>
<span class="n">env</span><span class="o">.</span><span class="na">CHART_NAME</span> <span class="o">=</span> <span class="s2">"go-demo-3-${env.BUILD_NUMBER}-${env.BRANCH_NAME}"</span>
<span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"jenkins-slave-${UUID.randomUUID().toString()}"</span>

<span class="n">podTemplate</span><span class="o">(</span>
  <span class="nl">label:</span> <span class="n">label</span><span class="o">,</span>
  <span class="nl">namespace:</span> <span class="s2">"go-demo-3-build"</span><span class="o">,</span>
  <span class="nl">serviceAccount:</span> <span class="s2">"build"</span><span class="o">,</span>
  <span class="nl">yaml:</span> <span class="s2">"""
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: helm
    image: vfarcic/helm:2.9.1
    command: ["cat"]
    tty: true
  - name: kubectl
    image: vfarcic/kubectl
    command: ["cat"]
    tty: true
  - name: golang
    image: golang:1.9
    command: ["cat"]
    tty: true
"""</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="n">node</span><span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s2">"build"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image build -t ${env.IMAGE}:${env.TAG_BETA} ."</span>
        <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"docker"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"sudo docker login -u $USER -p $PASS"</span>
        <span class="o">}</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:${env.TAG_BETA}"</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"func-test"</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
          <span class="n">sh</span> <span class="s2">"helm upgrade ${env.CHART_NAME} helm/go-demo-3 -i --tiller-namespace go-demo-3-build --set image.tag=${env.TAG_BETA} --set ingress.host=${env.ADDRESS} --set replicaCount=2 --set dbReplicaCount=1"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"kubectl"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"kubectl -n go-demo-3-build rollout status deployment ${env.CHART_NAME}"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"golang"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"go get -d -v -t"</span>
          <span class="n">sh</span> <span class="s2">"go test ./... -v --run FunctionalTest"</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">error</span> <span class="s2">"Failed functional tests"</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"helm delete ${env.CHART_NAME} --tiller-namespace go-demo-3-build --purge"</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"release"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"sudo docker pull ${env.IMAGE}:${env.TAG_BETA}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image tag ${env.IMAGE}:${env.TAG_BETA} ${env.IMAGE}:${env.TAG}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image tag ${env.IMAGE}:${env.TAG_BETA} ${env.IMAGE}:latest"</span>
        <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"docker"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"sudo docker login -u $USER -p $PASS"</span>
        <span class="o">}</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:${env.TAG}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:latest"</span>
      <span class="o">}</span>
      <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"helm package helm/go-demo-3"</span>
        <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"chartmuseum"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"""curl -u $USER:$PASS --data-binary "@go-demo-3-${CHART_VER}.tgz" http://${env.CM_ADDR}/api/charts"""</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="defining-the-release-stage-3">Defining The Release Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Wait until the build is finished</span>

open <span class="s2">"https://hub.docker.com/r/</span><span class="nv">$DH_USER</span><span class="s2">/go-demo-3/tags/"</span>

curl <span class="nt">-u</span> admin:admin <span class="s2">"http://</span><span class="nv">$CM_ADDR</span><span class="s2">/index.yaml"</span>
</code></pre></div></div>

<h2 id="defining-the-deploy-stage">Defining The Deploy Stage</h2>

<hr />

<!-- .slide: data-background="img/cdp-stages-deploy.png" data-background-size="contain" -->

<h2 id="defining-the-deploy-stage-1">Defining The Deploy Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nv">$ADDR</span>

open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/job/go-demo-3/configure"</span>
</code></pre></div></div>

<h2 id="defining-the-deploy-stage-2">Defining The Deploy Stage</h2>

<hr />

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span>

<span class="n">currentBuild</span><span class="o">.</span><span class="na">displayName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"yy.MM.dd"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">BUILD_NUMBER</span>
<span class="n">env</span><span class="o">.</span><span class="na">REPO</span> <span class="o">=</span> <span class="s2">"https://github.com/vfarcic/go-demo-3.git"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">IMAGE</span> <span class="o">=</span> <span class="s2">"vfarcic/go-demo-3"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">ADDRESS</span> <span class="o">=</span> <span class="s2">"go-demo-3-${env.BUILD_NUMBER}-${env.BRANCH_NAME}.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">PROD_ADDRESS</span> <span class="o">=</span> <span class="s2">"go-demo-3.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">CM_ADDR</span> <span class="o">=</span> <span class="s2">"cm.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">TAG</span> <span class="o">=</span> <span class="s2">"${currentBuild.displayName}"</span>
<span class="n">env</span><span class="o">.</span><span class="na">TAG_BETA</span> <span class="o">=</span> <span class="s2">"${env.TAG}-${env.BRANCH_NAME}"</span>
<span class="n">env</span><span class="o">.</span><span class="na">CHART_VER</span> <span class="o">=</span> <span class="s2">"0.0.1"</span>
<span class="n">env</span><span class="o">.</span><span class="na">CHART_NAME</span> <span class="o">=</span> <span class="s2">"go-demo-3-${env.BUILD_NUMBER}-${env.BRANCH_NAME}"</span>
<span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"jenkins-slave-${UUID.randomUUID().toString()}"</span>

<span class="n">podTemplate</span><span class="o">(</span>
  <span class="nl">label:</span> <span class="n">label</span><span class="o">,</span>
  <span class="nl">namespace:</span> <span class="s2">"go-demo-3-build"</span><span class="o">,</span>
  <span class="nl">serviceAccount:</span> <span class="s2">"build"</span><span class="o">,</span>
  <span class="nl">yaml:</span> <span class="s2">"""
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: helm
    image: vfarcic/helm:2.9.1
    command: ["cat"]
    tty: true
  - name: kubectl
    image: vfarcic/kubectl
    command: ["cat"]
    tty: true
  - name: golang
    image: golang:1.9
    command: ["cat"]
    tty: true
"""</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="n">node</span><span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s2">"build"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image build -t ${env.IMAGE}:${env.TAG_BETA} ."</span>
        <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"docker"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"sudo docker login -u $USER -p $PASS"</span>
        <span class="o">}</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:${env.TAG_BETA}"</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"func-test"</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
          <span class="n">sh</span> <span class="s2">"helm upgrade ${env.CHART_NAME} helm/go-demo-3 -i --tiller-namespace go-demo-3-build --set image.tag=${env.TAG_BETA} --set ingress.host=${env.ADDRESS} --set replicaCount=2 --set dbReplicaCount=1"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"kubectl"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"kubectl -n go-demo-3-build rollout status deployment ${env.CHART_NAME}"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"golang"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"go get -d -v -t"</span>
          <span class="n">sh</span> <span class="s2">"go test ./... -v --run FunctionalTest"</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">error</span> <span class="s2">"Failed functional tests"</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"helm delete ${env.CHART_NAME} --tiller-namespace go-demo-3-build --purge"</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"release"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"sudo docker pull ${env.IMAGE}:${env.TAG_BETA}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image tag ${env.IMAGE}:${env.TAG_BETA} ${env.IMAGE}:${env.TAG}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image tag ${env.IMAGE}:${env.TAG_BETA} ${env.IMAGE}:latest"</span>
        <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"docker"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"sudo docker login -u $USER -p $PASS"</span>
        <span class="o">}</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:${env.TAG}"</span>
        <span class="n">sh</span> <span class="s2">"sudo docker image push ${env.IMAGE}:latest"</span>
      <span class="o">}</span>
      <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"helm package helm/go-demo-3"</span>
        <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">"chartmuseum"</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">"USER"</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">"PASS"</span><span class="o">)])</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"""curl -u $USER:$PASS --data-binary "@go-demo-3-${CHART_VER}.tgz" http://${env.CM_ADDR}/api/charts"""</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"deploy"</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"helm upgrade go-demo-3 helm/go-demo-3 -i --tiller-namespace go-demo-3-build --namespace go-demo-3 --set image.tag=${env.TAG} --set ingress.host=${env.PROD_ADDRESS}"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"kubectl"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"kubectl -n go-demo-3 rollout status deployment go-demo-3"</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"golang"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"go get -d -v -t"</span>
          <span class="n">sh</span> <span class="s2">"DURATION=1 ADDRESS=${env.PROD_ADDRESS} go test ./... -v --run ProductionTest"</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"helm rollback go-demo-3 0 --tiller-namespace go-demo-3-build"</span>
          <span class="n">error</span> <span class="s2">"Failed production tests"</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="defining-the-deploy-stage-3">Defining The Deploy Stage</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Wait until the build is finished</span>

helm <span class="nb">ls</span> <span class="nt">--tiller-namespace</span> go-demo-3-build

kubectl <span class="nt">-n</span> go-demo-3 get pods

curl <span class="s2">"http://go-demo-3.</span><span class="nv">$ADDR</span><span class="s2">/demo/hello"</span>
</code></pre></div></div>

<h2 id="global-pipeline-libraries">Global Pipeline Libraries</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/configure"</span>
</code></pre></div></div>

<ul>
  <li>Click the <em>Add</em> button in <em>Global Pipeline Libraries</em></li>
  <li>Type <em>my-library</em> as the <em>Name</em></li>
  <li>Type <em>master</em> as the <em>Default version</em></li>
  <li>Click the <em>Load implicitly</em> checkbox</li>
  <li>Select <em>Modern SCM</em> from the <em>Retrieval method</em> section</li>
  <li>Select <em>Git</em> from <em>Source Code Management</em></li>
  <li>Go to <a href="https://github.com/vfarcic/jenkins-shared-libraries.git">vfarcic/jenkins-shared-libraries.git</a> and fork it</li>
  <li>Copy the address from the <em>Clone and download</em> drop-down list, return to Jenkins UI, and paste it into the <em>Project Repository</em> field</li>
  <li>Click the <em>Save</em> button to persist the changes</li>
</ul>

<h2 id="global-pipeline-libraries-1">Global Pipeline Libraries</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">GH_USER</span><span class="o">=[</span>...]

open <span class="s2">"https://github.com/</span><span class="nv">$GH_USER</span><span class="s2">/jenkins-shared-libraries.git"</span>

kubectl <span class="nt">-n</span> jenkins cp <span class="se">\</span>
    <span class="nv">$JENKINS_POD</span>:var/jenkins_home/org.jenkinsci.plugins.workflow.libs.GlobalLibraries.xml <span class="se">\</span>
    cluster/jenkins/secrets

<span class="nb">echo</span> <span class="nv">$ADDR</span>

open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/job/go-demo-3/configure"</span>
</code></pre></div></div>

<h2 id="global-pipeline-libraries-2">Global Pipeline Libraries</h2>

<hr />

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span>

<span class="n">currentBuild</span><span class="o">.</span><span class="na">displayName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"yy.MM.dd"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">BUILD_NUMBER</span>
<span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span> <span class="o">=</span> <span class="s2">"go-demo-3"</span>
<span class="n">env</span><span class="o">.</span><span class="na">REPO</span> <span class="o">=</span> <span class="s2">"https://github.com/vfarcic/go-demo-3.git"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">IMAGE</span> <span class="o">=</span> <span class="s2">"vfarcic/go-demo-3"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">DOMAIN</span> <span class="o">=</span> <span class="s2">"acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">ADDRESS</span> <span class="o">=</span> <span class="s2">"go-demo-3.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">CM_ADDR</span> <span class="o">=</span> <span class="s2">"cm.acme.com"</span> <span class="c1">// Change me!</span>
<span class="n">env</span><span class="o">.</span><span class="na">CHART_VER</span> <span class="o">=</span> <span class="s2">"0.0.1"</span>
<span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"jenkins-slave-${UUID.randomUUID().toString()}"</span>

<span class="n">podTemplate</span><span class="o">(</span>
  <span class="nl">label:</span> <span class="n">label</span><span class="o">,</span>
  <span class="nl">namespace:</span> <span class="s2">"go-demo-3-build"</span><span class="o">,</span>
  <span class="nl">serviceAccount:</span> <span class="s2">"build"</span><span class="o">,</span>
  <span class="nl">yaml:</span> <span class="s2">"""
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: helm
    image: vfarcic/helm:2.9.1
    command: ["cat"]
    tty: true
  - name: kubectl
    image: vfarcic/kubectl
    command: ["cat"]
    tty: true
  - name: golang
    image: golang:1.9
    command: ["cat"]
    tty: true
"""</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="n">node</span><span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s2">"build"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
        <span class="n">k8sBuildImageBeta</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">IMAGE</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"func-test"</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">git</span> <span class="s2">"${env.REPO}"</span>
          <span class="n">k8sUpgradeBeta</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">DOMAIN</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"kubectl"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">k8sRolloutBeta</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"golang"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">k8sFuncTestGolang</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">DOMAIN</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">error</span> <span class="s2">"Failed functional tests"</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">k8sDeleteBeta</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"release"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">node</span><span class="o">(</span><span class="s2">"docker"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">k8sPushImage</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">IMAGE</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">k8sPushHelm</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">CHART_VER</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">CM_ADDR</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"deploy"</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">k8sUpgrade</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"kubectl"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">k8sRollout</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"golang"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">k8sProdTestGolang</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s2">"helm"</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">k8sRollback</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">PROJECT</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="global-pipeline-libraries-3">Global Pipeline Libraries</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"https://hub.docker.com/r/</span><span class="nv">$DH_USER</span><span class="s2">/go-demo-3/tags/"</span>

helm <span class="nb">ls</span> <span class="nt">--tiller-namespace</span> go-demo-3-build

helm <span class="nb">history </span>go-demo-3 <span class="nt">--tiller-namespace</span> go-demo-3-build
</code></pre></div></div>

<h2 id="global-pipeline-libraries-docs">Global Pipeline Libraries Docs</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"https://github.com/</span><span class="nv">$GH_USER</span><span class="s2">/jenkins-shared-libraries/tree/master/vars"</span>

curl <span class="s2">"https://raw.githubusercontent.com/</span><span class="nv">$GH_USER</span><span class="s2">/jenkins-shared-libraries/master/vars/k8sBuildImageBeta.txt"</span>

open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/configureSecurity/"</span>
</code></pre></div></div>

<ul>
  <li>Change <em>Markup Formatter</em> to <em>PegDown</em></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/job/go-demo-3/"</span>
</code></pre></div></div>

<ul>
  <li>Navigate to <em>Pipeline Syntax</em> &gt; <em>Global Variables Reference</em></li>
</ul>

<h2 id="using-jenkinsfile--multistage-builds">Using Jenkinsfile &amp; Multistage Builds</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> ../go-demo-3/Jenkinsfile

<span class="nb">cat</span> ../go-demo-3/k8s/build-config.yml

<span class="nb">cat</span> ../go-demo-3/k8s/build-config.yml <span class="se">\</span>
    | sed <span class="nt">-e</span> <span class="s2">"s@acme.com@</span><span class="nv">$ADDR</span><span class="s2">@g"</span> <span class="se">\</span>
    | sed <span class="nt">-e</span> <span class="s2">"s@vfarcic@</span><span class="nv">$DH_USER</span><span class="s2">@g"</span> <span class="se">\</span>
    | kubectl apply <span class="nt">-f</span> - <span class="nt">--record</span>

open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/job/go-demo-3/"</span>
</code></pre></div></div>

<ul>
  <li>Click the <em>Delete Pipeline</em> link</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"http://</span><span class="nv">$JENKINS_ADDR</span><span class="s2">/blue/create-pipeline"</span>
</code></pre></div></div>

<h2 id="using-jenkinsfile--multistage-builds-1">Using Jenkinsfile &amp; Multistage Builds</h2>

<hr />

<ul>
  <li>Choose <em>GitHub</em></li>
  <li>Click the <em>Create an access token here</em> link to create a token if you do NOT have it already</li>
  <li>Type <em>Token description</em> and click the <em>Generate token</em> button</li>
  <li>Click the <em>Connect</em> button</li>
  <li>Choose your GitHub organization</li>
  <li>Type <em>go-demo-3</em> to filter the repositories and select it</li>
  <li>Click the <em>Create Pipeline</em> button</li>
  <li>Stop all the builds except <em>master</em></li>
</ul>

<h2 id="what-now">What Now?</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If using Docker For Desktop or minikube</span>
<span class="nb">cd cd</span>/docker-build

<span class="c"># If using Docker For Desktop or minikube</span>
vagrant <span class="nb">suspend</span>

<span class="c"># If using Docker For Desktop or minikube</span>
<span class="nb">cd</span> ../..
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/devops24/jenkins-cdp-demo.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
