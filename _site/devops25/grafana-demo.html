<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hands-On Time | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hands-On Time" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/devops25/grafana-demo.html" />
<meta property="og:url" content="http://localhost:4000/devops25/grafana-demo.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/devops25/grafana-demo.html","@type":"WebPage","headline":"Hands-On Time","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h2 id="hands-on-time">Hands-On Time</h2>

<hr />

<h1 id="visualizing-metrics-and-alerts">Visualizing Metrics And Alerts</h1>

<h2 id="installing-grafana">Installing Grafana</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm inspect values stable/grafana

<span class="nb">cat </span>mon/grafana-values-bare.yml

<span class="nv">GRAFANA_ADDR</span><span class="o">=</span><span class="s2">"grafana.</span><span class="nv">$LB_IP</span><span class="s2">.nip.io"</span>

helm install stable/grafana <span class="nt">--name</span> grafana <span class="nt">--namespace</span> metrics <span class="se">\</span>
    <span class="nt">--version</span> 1.17.5 <span class="nt">--set</span> ingress.hosts<span class="o">=</span><span class="s2">"{</span><span class="nv">$GRAFANA_ADDR</span><span class="s2">}"</span> <span class="se">\</span>
    <span class="nt">--values</span> mon/grafana-values-bare.yml

kubectl <span class="nt">-n</span> metrics rollout status deployment grafana

open <span class="s2">"http://</span><span class="nv">$GRAFANA_ADDR</span><span class="s2">"</span>

kubectl <span class="nt">-n</span> metrics get secret grafana <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data.admin-password}"</span> | base64 <span class="nt">--decode</span><span class="p">;</span> <span class="nb">echo</span>
</code></pre></div></div>

<h2 id="installing-grafana-1">Installing Grafana</h2>

<hr />

<ul>
  <li>Type <em>admin</em> as the <em>username</em></li>
  <li>Paste the output as the <em>password</em></li>
  <li>Click the <em>Add data source</em> icon</li>
  <li>Type <em>Prometheus</em> as the <em>Name</em></li>
  <li>Choose <em>prometheus</em> as the <em>Type</em></li>
  <li>Type <em>http://prometheus-server</em> as the <em>URL</em></li>
  <li>Click <em>Save &amp; Test</em></li>
</ul>

<h2 id="importing-dashboards">Importing Dashboards</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"https://grafana.com/dashboards"</span>
</code></pre></div></div>

<ul>
  <li>Click the <em>+</em> icon from the left-hand menu</li>
  <li>Click the <em>Import</em> link</li>
  <li>Type <em>3119</em> into the <em>Grafana.com Dashboard</em> field</li>
  <li>Click the <em>Load</em> button</li>
  <li>Choose <em>prometheus</em> from the <em>prometheus</em> drop-down list</li>
</ul>

<h2 id="importing-dashboards-1">Importing Dashboards</h2>

<hr />

<ul>
  <li>Please press the arrow next to the <em>Cluster filesystem usage</em></li>
  <li>Click the <em>Edit</em> link</li>
  <li>Click the <em>Back to dashboard</em> button</li>
  <li>Click the <em>Settings</em> icon located in the top of the screen</li>
  <li>Click the <em>Variables</em> link in the <em>Settings</em> section</li>
  <li>Click the <em>+ New</em> button</li>
  <li>Type <em>device</em> as the variable <em>Name</em></li>
  <li>Type <em>IO Device</em> as the <em>Label</em></li>
  <li>Select <em>$datasource</em></li>
  <li>Type the query that follows into the <em>Query</em> field</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>label_values(container_fs_usage_bytes, device)
</code></pre></div></div>

<h2 id="importing-dashboards-2">Importing Dashboards</h2>

<hr />

<ul>
  <li>Click the <em>Add</em> button</li>
  <li>Click the arrow next to the <em>Cluster filesystem usage</em> graph</li>
  <li>Select <em>edit</em></li>
  <li>Change <code class="highlighter-rouge">^/dev/xvda.$</code> to <code class="highlighter-rouge">$device</code></li>
  <li>Click the <em>Back to dashboard</em> button</li>
  <li>Repeat the same steps fro <em>Used</em> and <em>Total</em> panels</li>
  <li>Click the trash icon next to <em>System services CPU usage</em></li>
  <li>Click <em>Yes</em></li>
  <li>Repeat the same for <em>System services memory usage</em></li>
</ul>

<h2 id="creating-custom-dashboards">Creating Custom Dashboards</h2>

<hr />

<ul>
  <li>Click the <em>+</em> icon</li>
  <li>Choose to <em>Create Dashboard</em></li>
  <li>Select <em>Graph</em></li>
  <li>Click the <em>Settings</em></li>
  <li>Type <em>My Dashboard</em> as the <em>Name</em> of the dashboard</li>
  <li>Set the <em>Tags</em> to <em>Prometheus</em> and <em>Kubernetes</em></li>
  <li>Change the <em>Timezone</em> to <em>Local browser time</em></li>
</ul>

<h2 id="creating-custom-dashboards-1">Creating Custom Dashboards</h2>

<hr />

<ul>
  <li>Select the <em>Variables</em> section</li>
  <li>Click the <em>Add Variable</em> button</li>
  <li>Type <em>minCpu</em> as the <em>Name</em></li>
  <li>Choose <em>Constant</em> as the <em>Type</em></li>
  <li>Set the <em>Value</em> to <em>0.005</em></li>
  <li>Change the <em>Hide</em> value to <em>Variable</em></li>
  <li>Click the <em>Add</em> button, twice</li>
</ul>

<h2 id="creating-custom-dashboards-2">Creating Custom Dashboards</h2>

<hr />

<ul>
  <li>Create two more variables</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name:  cpuReqPercentMin
Type:  Constant
Label: Min % of requested CPU
Hide:  Variable
Value: 50
 
Name:  cpuReqPercentMax
Type:  Constant
Label: Max % of requested CPU
Hide:  Variable
Value: 150
</code></pre></div></div>

<ul>
  <li>Click the <em>Back to dashboard</em> icon</li>
</ul>

<h2 id="creating-custom-dashboards-3">Creating Custom Dashboards</h2>

<hr />

<ul>
  <li>Click on the arrow next to <em>Panel Title</em></li>
  <li>Select <em>Edit</em></li>
  <li>Select <em>General</em> section</li>
  <li>Write <em>% of actual vs reserved CPU</em> as the <em>Title</em></li>
  <li>Write the <em>Description</em> that follows</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The percentage of actual CPU usage compared to reserved. The calculation excludes Pods with reserved CPU equal to or smaller than $minCpu. Those with less than $minCpu of requested CPU are ignored.
</code></pre></div></div>

<h2 id="creating-custom-dashboards-4">Creating Custom Dashboards</h2>

<hr />

<ul>
  <li>Switch to the <em>Metrics</em> tab</li>
  <li>Type the query that follows in the field to the right of <em>A</em></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sum(label_join(
    rate(
        container_cpu_usage_seconds_total{
            namespace!="kube-system",
            pod_name!=""
        }[5m]
    ), 
    "pod", 
    ",", 
    "pod_name"
)) by (pod) / 
sum(
    kube_pod_container_resource_requests_cpu_cores{
        namespace!="kube-system",
        namespace!="ingress-nginx"
    }
) by (pod) and 
sum(
    kube_pod_container_resource_requests_cpu_cores{
        namespace!="kube-system",
        namespace!="ingress-nginx"
    }
) by (pod) &gt; $minCpu
</code></pre></div></div>

<h2 id="creating-custom-dashboards-5">Creating Custom Dashboards</h2>

<hr />

<ul>
  <li>Click the <em>Axes</em> tab</li>
  <li>Expand the <em>Left Y Unit</em></li>
  <li>Select <em>none</em>, followed with <em>percent (0.0-1.0)</em></li>
  <li>Uncheck the <em>Right Y Show</em> checkbox</li>
  <li>Select <em>Legend</em></li>
  <li>Check <em>Options As Table</em></li>
  <li>Check <em>Options To the right</em></li>
  <li>Check <em>Values &gt; Current</em> checkboxes</li>
</ul>

<h2 id="creating-custom-dashboards-6">Creating Custom Dashboards</h2>

<hr />

<ul>
  <li>Click the <em>Alert</em> tab</li>
  <li>Click the <em>Create Alert</em> button</li>
  <li>Change the <em>IS ABOVE</em> condition to <em>IS OUTSIDE RANGE</em></li>
  <li>Set the values of the next two fields to <em>0,5</em> and <em>1,5</em></li>
  <li>Go <em>Back to dashboard</em></li>
</ul>

<h2 id="creating-semaphores">Creating Semaphores</h2>

<hr />

<ul>
  <li>Please click the <em>Add panel</em> icon</li>
  <li>Select <em>Singlestat</em></li>
  <li>Click the arrow icon next to the <em>Panel Title</em></li>
  <li>Select <em>Edit</em></li>
  <li>Select the <em>General</em> tab</li>
  <li>Type the text that follows as the <em>Title</em></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pods with &lt; $cpuReqPercentMin% || &gt; $cpuReqPercentMax% actual compared to reserved CPU
</code></pre></div></div>

<ul>
  <li>Type the text that follows as the <em>Description</em></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The number of Pods with less than $cpuReqPercentMin% or more than $cpuReqPercentMax% actual compared to reserved CPU
</code></pre></div></div>

<h2 id="creating-semaphores-1">Creating Semaphores</h2>

<hr />

<ul>
  <li>Click the <em>Metrics</em> tab</li>
  <li>Type the expression that follows into the field next to <em>A</em></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sum(
    (
        sum(
            label_join(
                rate(container_cpu_usage_seconds_total{
                    namespace!="kube-system",
                    pod_name!=""}[5m]),
                    "pod", 
                    ",", 
                    "pod_name"
            )
        ) by (pod) / 
        sum(
            kube_pod_container_resource_requests_cpu_cores{
                namespace!="kube-system",
                namespace!="ingress-nginx"
            }
        ) by (pod) and
        sum(
            kube_pod_container_resource_requests_cpu_cores{
                namespace!="kube-system",
                namespace!="ingress-nginx"
            }
        ) by (pod) &gt; $minCpu
    ) &lt; bool ($cpuReqPercentMin / 100)
) + 
sum(
    (
        sum(
            label_join(
                rate(
                    container_cpu_usage_seconds_total{
                        namespace!="kube-system",
                        pod_name!=""
                    }[5m]
                ), 
                "pod", 
                ",", 
                "pod_name"
            )
        ) by (pod) / 
        sum(
            kube_pod_container_resource_requests_cpu_cores{
                namespace!="kube-system",
                namespace!="ingress-nginx"
            }
        ) by (pod) and 
        sum(
            kube_pod_container_resource_requests_cpu_cores{
                namespace!="kube-system",
                namespace!="ingress-nginx"
            }
        ) by (pod) &gt; $minCpu
    ) &gt; bool ($cpuReqPercentMax / 100)
)
</code></pre></div></div>

<h2 id="creating-semaphores-2">Creating Semaphores</h2>

<hr />

<ul>
  <li>Click the <em>Options</em> tab</li>
  <li>Changing the value of the <em>Stat</em> drop-down list to <em>Current</em></li>
  <li>Change the <em>Stat Font size</em> to <em>200%</em></li>
  <li>Check the <em>Coloring Background</em> checkbox</li>
  <li>Type <em>1</em> as the <em>Coloring Thresholds</em></li>
  <li>Click the red icon in <em>Coloring Colors</em></li>
  <li>Replace the value with the word <em>red</em></li>
  <li>Go <em>Back to dashboard</em></li>
  <li>Click the <em>Save Dashboard</em> icon</li>
  <li>Click the <em>Save</em> button</li>
</ul>

<h2 id="a-better-dashboard">A Better Dashboard</h2>

<hr />

<ul>
  <li>Click the <em>+</em> button</li>
  <li>Select <em>Import</em></li>
  <li>Type <em>9132</em> as the <em>Grafana.com Dashboard</em></li>
  <li>Press the <em>Load</em> button</li>
  <li><em>Select a Prometheus data source</em></li>
  <li>Click the <em>Import</em> button</li>
</ul>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/devops25/grafana-demo.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
