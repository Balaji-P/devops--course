<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hands-On Time | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hands-On Time" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/devops25/logging-demo.html" />
<meta property="og:url" content="http://localhost:4000/devops25/logging-demo.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/devops25/logging-demo.html","@type":"WebPage","headline":"Hands-On Time","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h2 id="hands-on-time">Hands-On Time</h2>

<hr />

<h1 id="collecting-and-querying-logs">Collecting And Querying Logs</h1>

<h2 id="logs-through-kubectl">Logs Through kubectl</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">GD5_ADDR</span><span class="o">=</span>go-demo-5.<span class="nv">$LB_IP</span>.nip.io

helm upgrade <span class="nt">-i</span> go-demo-5 <span class="se">\</span>
    https://github.com/vfarcic/go-demo-5/releases/download/0.0.1/go-demo-5-0.0.1.tgz <span class="se">\</span>
    <span class="nt">--namespace</span> go-demo-5 <span class="nt">--set</span> ingress.host<span class="o">=</span><span class="nv">$GD5_ADDR</span>

kubectl <span class="nt">-n</span> go-demo-5 rollout status deployment go-demo-5

curl <span class="s2">"http://</span><span class="nv">$GD5_ADDR</span><span class="s2">/demo/hello"</span>

kubectl <span class="nt">-n</span> go-demo-5 describe sts go-demo-5-db

kubectl <span class="nt">-n</span> go-demo-5 logs go-demo-5-db-0 <span class="nt">-c</span> db

kubectl <span class="nt">-n</span> go-demo-5 logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>go-demo-5
</code></pre></div></div>

<h2 id="exploring-centralized-logging-through-papertrail">Exploring Centralized Logging Through Papertrail</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"https://papertrailapp.com/"</span>
</code></pre></div></div>

<ul>
  <li>Register or log in</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"https://papertrailapp.com/start"</span>
</code></pre></div></div>

<ul>
  <li>Click the <em>Add systems</em> button.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PT_HOST</span><span class="o">=[</span>...]

<span class="nv">PT_PORT</span><span class="o">=[</span>...]

<span class="nb">cat </span>logging/fluentd-papertrail.yml

<span class="nb">cat </span>logging/fluentd-papertrail.yml <span class="se">\</span>
    | sed <span class="nt">-e</span> <span class="s2">"s@logsN.papertrailapp.com@</span><span class="nv">$PT_HOST</span><span class="s2">@g"</span> <span class="se">\</span>
    | sed <span class="nt">-e</span> <span class="s2">"s@NNNNN@</span><span class="nv">$PT_PORT</span><span class="s2">@g"</span> <span class="se">\</span>
    | kubectl apply <span class="nt">-f</span> - <span class="nt">--record</span>
</code></pre></div></div>

<h2 id="exploring-papertrail">Exploring Papertrail</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> logging <span class="se">\</span>
  rollout status ds fluentd-papertrail
</code></pre></div></div>

<ul>
  <li>Go back to Papertrail UI</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>logging/logger.yml

kubectl create <span class="nt">-f</span> logging/logger.yml

kubectl logs random-logger
</code></pre></div></div>

<ul>
  <li>Go back to Papertrail UI</li>
  <li>Type <em>random-logger</em> in the <em>Search</em> field</li>
  <li>Press the enter key</li>
</ul>

<h2 id="exploring-papertrail-1">Exploring Papertrail</h2>

<hr />

<ul>
  <li>Click the <em>Search tips</em> button</li>
  <li>Click the <em>Full Syntax Guide</em> link</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> logging/fluentd-papertrail.yml
</code></pre></div></div>

<h2 id="gcp-stackdriver-gke-only">GCP StackDriver (GKE Only)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> kube-system describe ds <span class="nt">-l</span> k8s-app<span class="o">=</span>fluentd-gcp

kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>fluentd-gcp <span class="nt">-c</span> fluentd-gcp
</code></pre></div></div>

<ul>
  <li>Open the link from the log entry</li>
  <li>Click the <em>ENABLE</em> button</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open <span class="s2">"https://console.cloud.google.com/logs/viewer"</span>
</code></pre></div></div>

<ul>
  <li>Type <em>random-logger</em> in <em>Filter by label or text search</em> field</li>
  <li>Select <em>GKE Container</em> from the drop-down list</li>
</ul>

<h2 id="aws-cloudwatch-eks-only">AWS CloudWatch (EKS Only)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PROFILE</span><span class="o">=</span><span class="k">$(</span>aws iam list-instance-profiles <span class="se">\</span>
  | jq <span class="nt">-r</span> <span class="s2">".InstanceProfiles[].InstanceProfileName"</span> <span class="se">\</span>
  | <span class="nb">grep </span>eksctl-<span class="nv">$NAME</span><span class="nt">-nodegroup-0</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$PROFILE</span>

<span class="nv">ROLE</span><span class="o">=</span><span class="k">$(</span>aws iam get-instance-profile <span class="se">\</span>
  <span class="nt">--instance-profile-name</span> <span class="nv">$PROFILE</span> <span class="se">\</span>
  | jq <span class="nt">-r</span> <span class="s2">".InstanceProfile.Roles[] | .RoleName"</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$ROLE</span>

<span class="nb">cat </span>logging/eks-logs-policy.json

aws iam put-role-policy <span class="nt">--role-name</span> <span class="nv">$ROLE</span> <span class="nt">--policy-name</span> eks-logs <span class="se">\</span>
  <span class="nt">--policy-document</span> file://logging/eks-logs-policy.json
</code></pre></div></div>

<h2 id="aws-cloudwatch-eks-only-1">AWS CloudWatch (EKS Only)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws iam get-role-policy <span class="nt">--role-name</span> <span class="nv">$ROLE</span> <span class="nt">--policy-name</span> eks-logs

<span class="nb">cat </span>logging/fluentd-eks.yml

kubectl apply <span class="nt">-f</span> logging/fluentd-eks.yml

kubectl <span class="nt">-n</span> logging get pods

open <span class="s2">"https://</span><span class="nv">$AWS_DEFAULT_REGION</span><span class="s2">.console.aws.amazon.com/cloudwatch/home?#logStream:group=/eks/</span><span class="nv">$NAME</span><span class="s2">/containers"</span>
</code></pre></div></div>

<ul>
  <li>Type <em>random-logger</em> in the <em>Log Stream Name Prefix</em> field</li>
  <li>Press the enter key</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> logging/fluentd-eks.yml

aws iam delete-role-policy <span class="nt">--role-name</span> <span class="nv">$ROLE</span> <span class="nt">--policy-name</span> eks-logs

aws logs delete-log-group <span class="se">\</span>
  <span class="nt">--log-group-name</span> <span class="s2">"/eks/devops25/containers"</span>
</code></pre></div></div>

<h2 id="azure-log-analytics-aks-only">Azure Log Analytics (AKS Only)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az aks enable-addons <span class="nt">-a</span> monitoring <span class="nt">-n</span> devops25-cluster <span class="se">\</span>
  <span class="nt">-g</span> devops25-group

kubectl <span class="nt">-n</span> kube-system get deployments

open <span class="s2">"https://portal.azure.com"</span>
</code></pre></div></div>

<ul>
  <li>Click the <em>All services</em> item</li>
  <li>Type <em>log analytics</em> in the <em>Filter</em> field</li>
  <li>Click the <em>Log Analytics</em> item</li>
  <li>Click the workspace</li>
  <li>Click the menu item <em>Logs</em> in the <em>General</em> section</li>
  <li>Type the query that follows in <em>Type your query hereâ€¦</em> field</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ContainerLog | where Name contains "random-logger"
</code></pre></div></div>

<h2 id="azure-log-analytics-aks-only-1">Azure Log Analytics (AKS Only)</h2>

<hr />

<ul>
  <li>Click the <em>Run</em> button</li>
  <li>Expand the <em>Columns</em> list</li>
  <li>Click the <em>SELECT NONE</em> button</li>
  <li>Select <em>LogEntry</em>, <em>Name</em>, and <em>TimeGenerated</em> fields</li>
  <li>Contract the <em>Columns</em> list</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az aks disable-addons <span class="nt">-a</span> monitoring <span class="nt">-n</span> devops25-cluster <span class="se">\</span>
  <span class="nt">-g</span> devops25-group
</code></pre></div></div>

<h2 id="efk">EFK</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>logging/es-values.yml

helm upgrade <span class="nt">-i</span> elasticsearch stable/elasticsearch <span class="se">\</span>
    <span class="nt">--version</span> 1.14.1 <span class="nt">--namespace</span> logging <span class="se">\</span>
    <span class="nt">--values</span> logging/es-values.yml

kubectl <span class="nt">-n</span> logging rollout status deployment elasticsearch-client

helm upgrade <span class="nt">-i</span> fluentd stable/fluentd-elasticsearch <span class="se">\</span>
    <span class="nt">--version</span> 1.4.0 <span class="nt">--namespace</span> logging <span class="se">\</span>
    <span class="nt">--values</span> logging/fluentd-values.yml

kubectl <span class="nt">-n</span> logging rollout status ds fluentd-fluentd-elasticsearch

kubectl <span class="nt">-n</span> logging logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>fluentd-fluentd-elasticsearch
</code></pre></div></div>

<h2 id="efk-1">EFK</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>logging/kibana-values.yml

<span class="nv">KIBANA_ADDR</span><span class="o">=</span>kibana.<span class="nv">$LB_IP</span>.nip.io

helm upgrade <span class="nt">-i</span> kibana stable/kibana <span class="nt">--version</span> 0.20.0 <span class="se">\</span>
    <span class="nt">--namespace</span> logging <span class="nt">--set</span> ingress.hosts<span class="o">=</span><span class="s2">"{</span><span class="nv">$KIBANA_ADDR</span><span class="s2">}"</span> <span class="se">\</span>
    <span class="nt">--values</span> logging/kibana-values.yml

kubectl <span class="nt">-n</span> logging rollout status deployment kibana

open <span class="s2">"http://</span><span class="nv">$KIBANA_ADDR</span><span class="s2">"</span>
</code></pre></div></div>

<h2 id="efk-2">EFK</h2>

<hr />

<ul>
  <li>Click the link to <em>Explore on my own</em></li>
  <li>Click the <em>Management</em> item from the left-hand menu</li>
  <li>Click the <em>Index Patterns</em> link</li>
  <li>Type <code class="highlighter-rouge">logstash-*</code> into the <em>Index pattern</em> field</li>
  <li>Click the <em>&gt; Next step</em> button</li>
  <li>Select <em>@timestamp</em> from the <em>Time Filter field name</em></li>
  <li>Click the <em>Create index pattern</em> button</li>
  <li>Click the <em>Discover</em> item from the left-hand menu</li>
  <li>Type the query that follows into the <em>Search</em> field</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubernetes.pod_name: "random-logger"
</code></pre></div></div>

<h2 id="efk-3">EFK</h2>

<hr />

<ul>
  <li>Click the <em>Refresh</em> (or <em>Update</em>) button</li>
  <li>Click the <em>Add</em> button next to the <em>log</em> field</li>
  <li>Expand one entry</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm delete kibana <span class="nt">--purge</span>

helm delete fluentd <span class="nt">--purge</span>

helm delete elasticsearch <span class="nt">--purge</span>

kubectl <span class="nt">-n</span> logging delete pvc <span class="se">\</span>
  <span class="nt">-l</span> <span class="nv">release</span><span class="o">=</span>elasticsearch,component<span class="o">=</span>data

kubectl <span class="nt">-n</span> logging delete pvc <span class="se">\</span>
  <span class="nt">-l</span> <span class="nv">release</span><span class="o">=</span>elasticsearch,component<span class="o">=</span>master
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/devops25/logging-demo.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
